<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StoryScript AI ‚Äî Full Production Suite</title>
<meta name="description" content="AI-powered faceless YouTube video production suite. Script ‚Üí Voiceover ‚Üí Video ‚Üí Thumbnail ‚Üí Upload.">
<meta name="theme-color" content="#c6ff47">
<meta property="og:title" content="StoryScript AI">
<meta property="og:description" content="Full AI production suite for faceless YouTube channels.">
<meta property="og:url" content="https://arinzaay007.github.io/storyscript-ai">
<meta property="og:type" content="website">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='7' fill='%23c6ff47'/><text y='24' x='5' font-size='22' font-family='Arial Black' font-weight='900'>S</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Bebas+Neue&family=Anton&family=Oswald:wght@400;600;700&family=DM+Mono:wght@300;400;500&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,300&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/mp4-muxer@5.0.3/build/mp4-muxer.min.js"></script>
<style>
:root{
  --bg:#07090f;--s:#0d1017;--s2:#12161f;--s3:#181d28;
  --b:rgba(255,255,255,.06);--b2:rgba(255,255,255,.11);
  --a:#c6ff47;--a2:#ff6b35;--a3:#47b4ff;--a4:#b47fff;
  --t:#eef0f4;--m:#6b7280;--m2:#9ca3af;
  --ok:#34d399;--err:#f87171;--warn:#fbbf24;
  --stage-h:52px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);color:var(--t);font-family:'DM Sans',sans-serif;font-weight:300;overflow:hidden}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--b2);border-radius:10px}

/* ‚ïê‚ïê‚ïê TOPBAR ‚ïê‚ïê‚ïê */
.topbar{height:var(--stage-h);display:flex;align-items:center;padding:0 20px;border-bottom:1px solid var(--b);background:var(--s);gap:0;flex-shrink:0;position:relative;z-index:10}
.logo{display:flex;align-items:center;gap:8px;margin-right:20px;flex-shrink:0}
.lm{width:26px;height:26px;background:var(--a);border-radius:5px;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-weight:800;font-size:.72rem;color:#000}
.lt{font-family:'Syne',sans-serif;font-weight:700;font-size:.88rem;white-space:nowrap}

/* Pipeline nav */
.pipe{display:flex;align-items:center;flex:1;gap:0}
.pstep{display:flex;align-items:center;gap:0;cursor:pointer;position:relative}
.pstep-inner{display:flex;align-items:center;gap:8px;padding:8px 16px;border-radius:7px;transition:all .18s}
.pstep:hover .pstep-inner{background:rgba(255,255,255,.04)}
.pstep.active .pstep-inner{background:rgba(198,255,71,.08)}
.pnum{width:22px;height:22px;border-radius:50%;background:var(--s2);border:1px solid var(--b2);display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-weight:800;font-size:.64rem;color:var(--m2);transition:all .2s;flex-shrink:0}
.pstep.active .pnum{background:var(--a);color:#000;border-color:transparent;box-shadow:0 0 12px rgba(198,255,71,.4)}
.pstep.done .pnum{background:var(--ok);color:#000;border-color:transparent}
.plabel{font-family:'Syne',sans-serif;font-weight:700;font-size:.76rem;color:var(--m2);transition:color .18s;white-space:nowrap}
.pstep.active .plabel{color:var(--a)}
.pstep.done .plabel{color:var(--ok)}
.parr{color:var(--m);font-size:.8rem;padding:0 4px;flex-shrink:0;opacity:.5}

/* Status pills */
.pill{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:100px;font-size:.63rem;font-family:'Syne',sans-serif;font-weight:600}
.pill.ok{background:rgba(52,211,153,.1);border:1px solid rgba(52,211,153,.2);color:var(--ok)}
.pill.pend{background:rgba(107,114,128,.08);border:1px solid rgba(107,114,128,.15);color:var(--m2)}
.pill.act{background:rgba(198,255,71,.1);border:1px solid rgba(198,255,71,.2);color:var(--a)}
.pill.warn{background:rgba(251,191,36,.08);border:1px solid rgba(251,191,36,.18);color:var(--warn)}

.topbar-right{display:flex;gap:6px;margin-left:auto;flex-shrink:0}
.tbtn{padding:6px 13px;border-radius:6px;font-size:.75rem;font-family:'Syne',sans-serif;font-weight:600;cursor:pointer;transition:all .15s;border:1px solid var(--b2);background:transparent;color:var(--m2);white-space:nowrap}
.tbtn:hover{color:var(--t);border-color:rgba(255,255,255,.18)}
.tbtn.acc{background:var(--a);color:#000;border-color:transparent}
.tbtn.acc:hover{box-shadow:0 0 24px rgba(198,255,71,.28);transform:translateY(-1px)}
.tbtn:disabled{opacity:.4;cursor:not-allowed;transform:none!important;box-shadow:none!important}

/* ‚ïê‚ïê‚ïê LAYOUT ‚ïê‚ïê‚ïê */
.app{height:calc(100vh - var(--stage-h));overflow:hidden;display:flex;flex-direction:column}

/* Stages */
.stage{display:none;flex:1;overflow:hidden;animation:fadeUp .22s ease}
.stage.active{display:flex}
@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* ‚ïê‚ïê‚ïê SHARED COMPONENTS ‚ïê‚ïê‚ïê */
.col{display:flex;flex-direction:column;overflow:hidden}
.phead{padding:12px 18px;border-bottom:1px solid var(--b);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;background:var(--s)}
.phead-t{font-family:'Syne',sans-serif;font-weight:700;font-size:.82rem;display:flex;align-items:center;gap:7px}
.pscroll{flex:1;overflow-y:auto;padding:15px 18px}
.pfoot{padding:13px 18px;border-top:1px solid var(--b);background:var(--s);flex-shrink:0}
.label{font-size:.66rem;color:var(--m2);letter-spacing:.06em;text-transform:uppercase;margin-bottom:6px;display:block;font-family:'Syne',sans-serif;font-weight:600}
.inp{width:100%;background:var(--s2);border:1px solid var(--b2);border-radius:7px;padding:8px 11px;color:var(--t);font-family:'DM Sans',sans-serif;font-size:.84rem;outline:none;transition:border-color .2s}
.inp:focus{border-color:rgba(198,255,71,.35)}
.textarea{width:100%;background:var(--s2);border:1px solid var(--b2);border-radius:7px;padding:9px 11px;color:var(--t);font-family:'DM Sans',sans-serif;font-size:.82rem;line-height:1.7;resize:none;outline:none;transition:border-color .2s}
.textarea:focus{border-color:rgba(198,255,71,.35)}
.sel{width:100%;background:var(--s2);border:1px solid var(--b2);border-radius:7px;padding:8px 11px;color:var(--t);font-family:'DM Sans',sans-serif;font-size:.84rem;outline:none;cursor:pointer;appearance:none}
.sel option{background:#1a1f2e}
.tags{display:flex;gap:5px;flex-wrap:wrap}
.tag{padding:4px 10px;border-radius:100px;font-size:.7rem;border:1px solid var(--b2);cursor:pointer;transition:all .15s;color:var(--m2)}
.tag:hover{border-color:rgba(198,255,71,.3);color:var(--a)}
.tag.on{background:rgba(198,255,71,.1);border-color:rgba(198,255,71,.3);color:var(--a)}
.sec{margin-bottom:14px}
.divider{height:1px;background:var(--b);margin:12px 0}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
input[type=range]{-webkit-appearance:none;width:100%;height:3px;background:var(--s3);border-radius:2px;outline:none;cursor:pointer}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:13px;height:13px;background:var(--a);border-radius:50%;cursor:pointer}
.slider-hd{display:flex;justify-content:space-between;margin-bottom:5px}
.sv{font-family:'DM Mono',monospace;font-size:.7rem;color:var(--a);font-weight:500}

/* Big action btn */
.bigbtn{width:100%;padding:12px;border:none;border-radius:8px;font-family:'Syne',sans-serif;font-weight:800;font-size:.9rem;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:7px;background:var(--a);color:#000}
.bigbtn:hover:not(:disabled){box-shadow:0 0 36px rgba(198,255,71,.28);transform:translateY(-1px)}
.bigbtn:disabled{opacity:.45;cursor:not-allowed;transform:none;box-shadow:none}
.bigbtn.stop{background:var(--err);color:#fff;animation:rp 1.5s ease-in-out infinite}
@keyframes rp{0%,100%{box-shadow:0 0 0 rgba(248,113,113,0)}50%{box-shadow:0 0 26px rgba(248,113,113,.4)}}
.spin{width:16px;height:16px;border:2.5px solid rgba(0,0,0,.2);border-top-color:#000;border-radius:50%;animation:spin .7s linear infinite;display:none}
@keyframes spin{to{transform:rotate(360deg)}}

/* Next CTA */
.next-cta{display:flex;align-items:center;justify-content:space-between;background:rgba(198,255,71,.06);border:1px solid rgba(198,255,71,.18);border-radius:8px;padding:12px 15px;cursor:pointer;transition:all .18s;margin-top:4px}
.next-cta:hover{background:rgba(198,255,71,.1);transform:translateX(3px)}
.nc-txt{font-family:'Syne',sans-serif;font-weight:700;font-size:.83rem;color:var(--a)}
.nc-sub{font-size:.7rem;color:var(--m);margin-top:2px}

/* ‚ïê‚ïê‚ïê STAGE 1: SCRIPT ‚ïê‚ïê‚ïê */
#s1{display:none}
#s1.active{display:grid;grid-template-columns:1fr 1fr}
.s1-out-section{border-bottom:1px solid var(--b);padding:11px 0}
.s1-out-section:last-child{border-bottom:none}
.s1-sec-label{font-size:.6rem;letter-spacing:.15em;text-transform:uppercase;font-weight:700;margin-bottom:6px}
.s1-sec-text{font-size:.83rem;line-height:1.75;color:var(--m2)}
.loading-bar{height:10px;border-radius:3px;background:linear-gradient(90deg,var(--s2) 25%,rgba(198,255,71,.06) 50%,var(--s2) 75%);background-size:200% 100%;animation:shim 1.4s infinite;margin-bottom:7px}
@keyframes shim{0%{background-position:-200% 0}100%{background-position:200% 0}}

/* ‚ïê‚ïê‚ïê STAGE 2: VOICEOVER ‚ïê‚ïê‚ïê */
#s2{display:none}
#s2.active{display:grid;grid-template-columns:380px 1fr}
.vcgrid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.vc{background:var(--s2);border:1px solid var(--b);border-radius:8px;padding:10px;cursor:pointer;transition:all .18s;position:relative}
.vc.on{border-color:rgba(198,255,71,.3);background:rgba(198,255,71,.04)}
.vc-dot{position:absolute;top:8px;right:8px;width:6px;height:6px;border-radius:50%;background:var(--a);display:none;box-shadow:0 0 7px rgba(198,255,71,.5)}
.vc.on .vc-dot{display:block}
.vc-top{display:flex;align-items:center;gap:8px;margin-bottom:5px}
.vc-av{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.85rem;flex-shrink:0}
.vc-name{font-family:'Syne',sans-serif;font-weight:700;font-size:.78rem}
.vc-meta{font-size:.68rem;color:var(--m)}
.vc-tags2{display:flex;gap:3px}
.vc-tag{padding:2px 6px;border-radius:100px;font-size:.6rem;background:var(--s3);border:1px solid var(--b);color:var(--m2)}
.wv-box{background:var(--bg);border:1px solid var(--b);border-radius:9px;height:96px;position:relative;overflow:hidden;margin-bottom:13px}
#wv{width:100%;height:100%;display:block}
.wv-ph{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;gap:7px;color:var(--m);font-size:.78rem;pointer-events:none}
.player{background:var(--s2);border:1px solid var(--b2);border-radius:8px;padding:11px;display:flex;align-items:center;gap:11px;margin-bottom:12px}
.play-btn{width:36px;height:36px;border-radius:50%;background:var(--a);border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all .15s}
.play-btn:hover{transform:scale(1.08);box-shadow:0 0 14px rgba(198,255,71,.3)}
.play-btn:disabled{opacity:.4;cursor:not-allowed;transform:none;box-shadow:none}
.player-info{flex:1}
.player-name{font-family:'Syne',sans-serif;font-weight:700;font-size:.78rem;margin-bottom:4px}
.prog-bg{height:3px;background:var(--s3);border-radius:2px;cursor:pointer;overflow:hidden}
.prog-fill{height:100%;background:var(--a);border-radius:2px;width:0%;transition:width .08s linear}
.player-time{display:flex;justify-content:space-between;font-family:'DM Mono',monospace;font-size:.63rem;color:var(--m);margin-top:3px}
.vostats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:12px}
.vostat{background:var(--s2);border:1px solid var(--b);border-radius:7px;padding:9px;text-align:center}
.vostat-val{font-family:'Syne',sans-serif;font-weight:800;font-size:.95rem;color:var(--a);margin-bottom:1px}
.vostat-lbl{font-size:.62rem;color:var(--m);text-transform:uppercase;letter-spacing:.04em}

/* ‚ïê‚ïê‚ïê STAGE 3: VIDEO ‚ïê‚ïê‚ïê */
#s3{display:none}
#s3.active{display:grid;grid-template-columns:288px 1fr 256px}
.canvas-area{flex:1;display:flex;align-items:center;justify-content:center;padding:16px;overflow:hidden;position:relative;background:var(--bg)}
.canvas-shell{position:relative;border-radius:8px;overflow:hidden;box-shadow:0 20px 70px rgba(0,0,0,.85),0 0 0 1px rgba(255,255,255,.05)}
#vc3{display:block}
.rec-badge{position:absolute;top:7px;left:7px;background:rgba(0,0,0,.75);border:1px solid var(--b2);border-radius:4px;padding:3px 8px;font-family:'DM Mono',monospace;font-size:.6rem;color:var(--m2);pointer-events:none}
.rec-badge.live{border-color:rgba(248,113,113,.5);color:var(--err)}
.recdot{display:inline-block;width:5px;height:5px;border-radius:50%;background:var(--err);margin-right:4px;animation:rb .9s infinite}
@keyframes rb{0%,100%{opacity:1}50%{opacity:.15}}
.vid-prog{padding:7px 15px;border-top:1px solid var(--b);background:var(--s);flex-shrink:0}
.vpbg{height:3px;background:var(--s2);border-radius:2px;overflow:hidden;margin-bottom:3px}
.vpfill{height:100%;background:linear-gradient(90deg,var(--a),var(--a3));border-radius:2px;width:0%;transition:width .18s}
.vpinfo{display:flex;justify-content:space-between;font-family:'DM Mono',monospace;font-size:.61rem;color:var(--m)}
.sbar{height:29px;background:var(--s);border-top:1px solid var(--b);display:flex;align-items:center;padding:0 15px;gap:10px;flex-shrink:0}
.si{display:flex;align-items:center;gap:4px;font-size:.63rem;color:var(--m);white-space:nowrap}
.sd{width:6px;height:6px;border-radius:50%;background:var(--m)}
.sd.g{background:var(--ok);box-shadow:0 0 5px rgba(52,211,153,.5)}
.sd.r{background:var(--err);animation:sdp .8s infinite}
.sd.y{background:var(--warn);animation:sdp 1.2s infinite}
@keyframes sdp{0%,100%{opacity:1}50%{opacity:.2}}
.sv2{color:var(--t);font-weight:500;font-family:'DM Mono',monospace;font-size:.63rem}
.ssep{width:1px;height:10px;background:var(--b2)}
.sc-card{background:var(--s2);border:1px solid var(--b);border-radius:7px;overflow:hidden;margin-bottom:6px;cursor:pointer;transition:border-color .15s}
.sc-card:hover,.sc-card.on{border-color:rgba(198,255,71,.22)}
.sc-card.on{background:rgba(198,255,71,.02)}
.sc-head{display:flex;align-items:center;gap:7px;padding:7px 9px}
.sc-n{font-family:'DM Mono',monospace;font-size:.58rem;color:var(--a);min-width:32px}
.sc-txt{font-size:.74rem;color:var(--m2);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sc-d{font-size:.63rem;color:var(--m)}
.sc-img-row{padding:0 9px 8px;display:flex;gap:6px;align-items:center}
.sc-thumb{width:48px;height:30px;border-radius:4px;object-fit:cover;border:1px solid var(--b2);flex-shrink:0}
.sc-noimg{width:48px;height:30px;border-radius:4px;background:var(--s3);border:1px solid var(--b);display:flex;align-items:center;justify-content:center;font-size:.58rem;color:var(--m);flex-shrink:0}
.sc-btns{display:flex;gap:4px;flex-wrap:wrap}
.sc-btn{padding:2px 7px;border-radius:100px;font-size:.62rem;border:1px solid var(--b2);background:transparent;color:var(--m2);cursor:pointer;transition:all .15s}
.sc-btn:hover{border-color:rgba(198,255,71,.3);color:var(--a)}
.sc-btn.loading{opacity:.5;pointer-events:none}
.sc-prompt-tip{font-size:.59rem;color:var(--m);margin-top:2px;font-style:italic;line-height:1.35}
.export-card{background:var(--s2);border:1px solid var(--b);border-radius:7px;padding:11px;margin-bottom:7px}
.ec-t{font-family:'Syne',sans-serif;font-weight:700;font-size:.75rem;margin-bottom:3px}
.ec-d{font-size:.7rem;color:var(--m);margin-bottom:8px;line-height:1.45}
.ec-btn{width:100%;padding:8px;border-radius:6px;font-family:'Syne',sans-serif;font-weight:700;font-size:.76rem;cursor:pointer;transition:all .15s;border:1px solid var(--b2);background:transparent;color:var(--m2);display:flex;align-items:center;justify-content:center;gap:5px}
.ec-btn:hover{color:var(--t);border-color:rgba(255,255,255,.18)}
.ec-btn.mp4{background:var(--a3);color:#000;border:none}
.ec-btn.mp4:hover{box-shadow:0 3px 16px rgba(71,180,255,.25)}
.ec-btn:disabled{opacity:.4;cursor:not-allowed;box-shadow:none}
.done-ov{position:absolute;inset:0;background:rgba(7,9,15,.9);display:none;flex-direction:column;align-items:center;justify-content:center;gap:10px;backdrop-filter:blur(6px);border-radius:8px}
.done-ov.show{display:flex}
.done-title{font-family:'Syne',sans-serif;font-weight:800;font-size:1.15rem;color:var(--a)}
.done-sub{font-size:.78rem;color:var(--m);text-align:center;max-width:220px;line-height:1.45}
.done-btns{display:flex;gap:7px;margin-top:3px}
.db{padding:8px 15px;border-radius:6px;font-family:'Syne',sans-serif;font-weight:700;font-size:.78rem;cursor:pointer;border:1px solid var(--b2);background:transparent;color:var(--t);transition:all .15s}
.db.p{background:var(--a);color:#000;border:none}
.db.m{background:var(--a3);color:#000;border:none}
.mp4prog{background:rgba(71,180,255,.05);border:1px solid rgba(71,180,255,.2);border-radius:7px;padding:11px;margin-bottom:7px;display:none}
.mp4prog.show{display:block}
.mp4prog-t{font-family:'Syne',sans-serif;font-weight:700;font-size:.74rem;color:var(--a3);margin-bottom:6px}
.mp4bg{height:3px;background:var(--s3);border-radius:2px;overflow:hidden;margin-bottom:4px}
.mp4fill{height:100%;background:linear-gradient(90deg,var(--a3),var(--a4));width:0%;border-radius:2px;transition:width .18s}
.mp4lbl{font-family:'DM Mono',monospace;font-size:.61rem;color:var(--m)}

/* Caption styles */
.cap-grid{display:grid;grid-template-columns:1fr 1fr;gap:5px}
.cap-card{background:var(--s2);border:1px solid var(--b);border-radius:7px;padding:8px;cursor:pointer;text-align:center;transition:all .15s}
.cap-card.on{border-color:rgba(198,255,71,.3);background:rgba(198,255,71,.04)}
.cap-card-e{font-size:1rem;margin-bottom:2px}
.cap-card-l{font-family:'Syne',sans-serif;font-weight:700;font-size:.68rem;color:var(--m2)}
.cap-card.on .cap-card-l{color:var(--a)}
.tog-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.tog-label{font-family:'Syne',sans-serif;font-weight:700;font-size:.76rem}
.tog{width:34px;height:19px;border-radius:10px;background:var(--s3);border:1px solid var(--b2);cursor:pointer;position:relative;transition:background .2s;flex-shrink:0}
.tog.on{background:var(--a)}
.tog::after{content:'';position:absolute;top:2.5px;left:2.5px;width:12px;height:12px;border-radius:50%;background:#fff;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.3)}
.tog.on::after{transform:translateX(15px)}

/* ‚ïê‚ïê‚ïê STAGE 4: THUMBNAIL ‚ïê‚ïê‚ïê */
#s4{display:none}
#s4.active{display:grid;grid-template-columns:300px 1fr 260px}
.layout-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:5px}
.lcard{aspect-ratio:16/9;border-radius:6px;cursor:pointer;border:2px solid var(--b);overflow:hidden;transition:all .16s;background:var(--s3)}
.lcard:hover{border-color:rgba(198,255,71,.3)}
.lcard.on{border-color:var(--a);box-shadow:0 0 10px rgba(198,255,71,.18)}
.lcard svg{width:100%;height:100%;display:block}
.swatch-row{display:flex;gap:5px;flex-wrap:wrap}
.swatch{width:22px;height:22px;border-radius:4px;cursor:pointer;border:2px solid transparent;transition:all .14s;flex-shrink:0}
.swatch.on{border-color:#fff;transform:scale(1.18)}
.tc-area{flex:1;display:flex;align-items:center;justify-content:center;padding:20px;overflow:hidden;position:relative;background:var(--bg)}
.tc-shell{position:relative;border-radius:9px;overflow:hidden;box-shadow:0 22px 72px rgba(0,0,0,.85),0 0 0 1px rgba(255,255,255,.05)}
#tc{display:block}
.shimmer{position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(198,255,71,.07),transparent);background-size:200% 100%;animation:shim 1.4s infinite;display:none;z-index:5}
.shimmer.show{display:block}
.var-strip{display:flex;gap:7px;padding:8px 16px;border-top:1px solid var(--b);flex-shrink:0;overflow-x:auto;background:var(--s)}
.var-strip::-webkit-scrollbar{height:3px}
.vthumb{width:90px;height:51px;border-radius:5px;cursor:pointer;border:2px solid var(--b);flex-shrink:0;overflow:hidden;position:relative;transition:all .14s}
.vthumb:hover{border-color:rgba(198,255,71,.3)}
.vthumb.on{border-color:var(--a)}
.vthumb canvas{width:100%;height:100%;display:block}
.vt-lbl{position:absolute;bottom:2px;left:0;right:0;text-align:center;font-size:.52rem;font-family:'Syne',sans-serif;font-weight:700;color:rgba(255,255,255,.55)}
.tc-foot{height:38px;background:var(--s);border-top:1px solid var(--b);display:flex;align-items:center;padding:0 18px;gap:10px;flex-shrink:0}
.tc-info{font-family:'DM Mono',monospace;font-size:.63rem;color:var(--m)}
.layer-card{background:var(--s2);border:1px solid var(--b);border-radius:7px;padding:10px;margin-bottom:7px;cursor:pointer}
.layer-card.alc{border-color:rgba(198,255,71,.3)}
.lc-head{display:flex;align-items:center;gap:7px;margin-bottom:7px}
.lc-type{font-family:'DM Mono',monospace;font-size:.6rem;color:var(--a);padding:2px 6px;background:rgba(198,255,71,.08);border-radius:100px}
.lc-inp{flex:1;background:transparent;border:none;color:var(--t);font-family:'Syne',sans-serif;font-weight:700;font-size:.78rem;outline:none}
.lc-del{width:19px;height:19px;border-radius:3px;background:transparent;border:none;color:var(--m);cursor:pointer;font-size:.78rem;display:flex;align-items:center;justify-content:center;transition:all .14s}
.lc-del:hover{background:rgba(248,113,113,.1);color:var(--err)}
.lc-row{display:grid;grid-template-columns:1fr 1fr;gap:5px}
.mini{width:100%;background:var(--s3);border:1px solid var(--b2);border-radius:5px;padding:5px 7px;color:var(--t);font-family:'DM Sans',sans-serif;font-size:.76rem;outline:none}
.add-lbtn{width:100%;padding:8px;border-radius:7px;border:1px dashed var(--b2);background:transparent;color:var(--m2);font-family:'Syne',sans-serif;font-weight:600;font-size:.73rem;cursor:pointer;transition:all .14s;display:flex;align-items:center;justify-content:center;gap:5px}
.add-lbtn:hover{border-color:rgba(198,255,71,.3);color:var(--a);background:rgba(198,255,71,.03)}

/* ‚ïê‚ïê‚ïê A/B VARIANTS ‚ïê‚ïê‚ïê */
.ab-wrap{display:flex;flex-direction:column;gap:7px;margin-top:8px}
.ab-card{background:var(--s2);border:1px solid var(--b2);border-radius:8px;padding:11px 13px;cursor:pointer;transition:all .16s;position:relative}
.ab-card:hover{border-color:rgba(198,255,71,.3)}
.ab-card.chosen{border-color:var(--a);background:rgba(198,255,71,.04)}
.ab-badge{position:absolute;top:8px;right:9px;font-size:.58rem;font-family:'Syne',sans-serif;font-weight:700;padding:2px 6px;border-radius:100px;background:rgba(198,255,71,.12);color:var(--a)}
.ab-text{font-size:.81rem;line-height:1.65;color:var(--m2)}
.ab-card.chosen .ab-text{color:var(--t)}

/* ‚ïê‚ïê‚ïê MUSIC BED ‚ïê‚ïê‚ïê */
.music-tracks{display:flex;flex-direction:column;gap:5px;margin-top:6px}
.mtrack{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:7px;border:1px solid var(--b2);background:var(--s2);cursor:pointer;transition:all .14s}
.mtrack:hover{border-color:rgba(198,255,71,.25)}
.mtrack.on{border-color:var(--a);background:rgba(198,255,71,.05)}
.mt-dot{width:8px;height:8px;border-radius:50%;background:var(--b2);flex-shrink:0;transition:background .14s}
.mtrack.on .mt-dot{background:var(--a)}
.mt-info{flex:1;min-width:0}
.mt-name{font-family:'Syne',sans-serif;font-weight:700;font-size:.73rem}
.mt-meta{font-size:.64rem;color:var(--m);margin-top:1px}
.mt-bpm{font-family:'DM Mono',monospace;font-size:.62rem;color:var(--m2);flex-shrink:0}

/* ‚ïê‚ïê‚ïê SRT / CHAPTERS / ANALYTICS MODALS ‚ïê‚ïê‚ïê */
.feature-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:998;align-items:center;justify-content:center}
.feature-modal.open{display:flex}
.fmod-box{background:#0d1017;border:1px solid rgba(255,255,255,.1);border-radius:14px;width:560px;max-width:95vw;max-height:88vh;overflow-y:auto;padding:26px;position:relative}
.fmod-title{font-family:'Syne',sans-serif;font-weight:800;font-size:1rem;margin-bottom:4px;display:flex;align-items:center;gap:8px}
.fmod-sub{font-size:.76rem;color:var(--m2);margin-bottom:18px}
.fmod-code{background:var(--s2);border:1px solid var(--b2);border-radius:7px;padding:12px;font-family:'DM Mono',monospace;font-size:.71rem;line-height:1.65;color:var(--m2);white-space:pre-wrap;max-height:260px;overflow-y:auto;margin-bottom:12px}
.score-ring{width:100px;height:100px;flex-shrink:0}
.analytics-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
.ametric{background:var(--s2);border:1px solid var(--b2);border-radius:8px;padding:12px;text-align:center}
.am-val{font-family:'Syne',sans-serif;font-weight:800;font-size:1.4rem;margin-bottom:2px}
.am-lbl{font-size:.65rem;color:var(--m2);text-transform:uppercase;letter-spacing:.05em}
.am-bar{height:4px;border-radius:2px;background:var(--s3);margin-top:8px;overflow:hidden}
.am-fill{height:100%;border-radius:2px;transition:width .8s ease}
.sched-row{display:flex;gap:8px;align-items:flex-end}

/* ‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê */
.toasts{position:fixed;bottom:12px;right:12px;display:flex;flex-direction:column;gap:5px;z-index:9999;pointer-events:none}
.toast{background:var(--s2);border:1px solid var(--b2);border-radius:7px;padding:8px 12px;font-size:.76rem;animation:tin .2s ease;box-shadow:0 5px 20px rgba(0,0,0,.5);max-width:260px}
@keyframes tin{from{opacity:0;transform:translateX(8px)}to{opacity:1;transform:translateX(0)}}
.toast.ok{border-color:rgba(52,211,153,.3)}
.toast.err{border-color:rgba(248,113,113,.3)}
.toast.info{border-color:rgba(71,180,255,.3)}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOPBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="topbar">
  <div class="logo"><div class="lm">SS</div><div class="lt">StoryScript AI</div></div>
  <div class="pipe">
    <div class="pstep active" id="ps1" onclick="goStage(1)">
      <div class="pstep-inner"><div class="pnum" id="pn1">1</div><div class="plabel">Script</div></div>
    </div>
    <div class="parr">‚Ä∫</div>
    <div class="pstep" id="ps2" onclick="goStage(2)">
      <div class="pstep-inner"><div class="pnum" id="pn2">2</div><div class="plabel">Voiceover</div></div>
    </div>
    <div class="parr">‚Ä∫</div>
    <div class="pstep" id="ps3" onclick="goStage(3)">
      <div class="pstep-inner"><div class="pnum" id="pn3">3</div><div class="plabel">Video</div></div>
    </div>
    <div class="parr">‚Ä∫</div>
    <div class="pstep" id="ps4" onclick="goStage(4)">
      <div class="pstep-inner"><div class="pnum" id="pn4">4</div><div class="plabel">Thumbnail</div></div>
    </div>
  </div>
  <div class="topbar-right">
    <div class="pill pend" id="global-status">Stage 1 of 4</div>
    <button class="tbtn" id="prev-btn" disabled onclick="goStage(curStage-1)">‚Äπ Back</button>
    <button class="tbtn acc" id="next-btn" onclick="goStage(curStage+1)">Next: Voiceover ‚Ä∫</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="app">

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STAGE 1: SCRIPT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="stage" id="s1">
  <!-- LEFT -->
  <div class="col" style="border-right:1px solid var(--b);background:var(--s)">
    <div class="phead"><div class="phead-t">‚úçÔ∏è Script Generator</div><div class="pill pend" id="s1pill">Not generated</div></div>
    <div class="pscroll">
      <div class="sec"><label class="label">Video Topic</label><input class="inp" id="g-topic" type="text" placeholder="e.g. 7 habits of self-made millionaires" value="7 habits of self-made millionaires"></div>
      <div class="sec"><label class="label">Niche</label>
        <select class="sel" id="g-niche">
          <option value="finance">üí∞ Finance & Investing</option>
          <option value="history">üìú History</option>
          <option value="motivation">üî• Motivation & Self Help</option>
          <option value="tech">üíª Technology</option>
          <option value="health">üèÉ Health & Fitness</option>
          <option value="mystery">üîÆ Mystery & Conspiracy</option>
          <option value="science">üî¨ Science</option>
        </select>
      </div>
      <div class="sec"><label class="label">Tone</label>
        <div class="tags" id="g-tone">
          <div class="tag on" onclick="pt(this,'g-tone')">Engaging</div>
          <div class="tag" onclick="pt(this,'g-tone')">Dramatic</div>
          <div class="tag" onclick="pt(this,'g-tone')">Educational</div>
          <div class="tag" onclick="pt(this,'g-tone')">Conversational</div>
        </div>
      </div>
      <div class="sec"><label class="label">Hook Style</label>
        <div class="tags" id="g-hook">
          <div class="tag on" onclick="pt(this,'g-hook')">Bold Statement</div>
          <div class="tag" onclick="pt(this,'g-hook')">Question</div>
          <div class="tag" onclick="pt(this,'g-hook')">Shocking Stat</div>
          <div class="tag" onclick="pt(this,'g-hook')">Story</div>
        </div>
      </div>
      <div class="sec">
        <div class="slider-hd"><label class="label" style="margin:0">Duration</label><span class="sv" id="gdur-v">8 min</span></div>
        <input type="range" id="g-dur" min="3" max="20" value="8" oninput="document.getElementById('gdur-v').textContent=this.value+' min'">
      </div>
      <div class="sec"><label class="label">Extra Notes</label><textarea class="textarea" id="g-notes" rows="3" placeholder="Specific angle or points..."></textarea></div>
    </div>
    <div class="pfoot"><button class="bigbtn" id="s1btn" onclick="generateScript()"><div class="spin" id="s1spin"></div><span id="s1icon">‚ö°</span><span id="s1txt">Generate Script with AI</span></button></div>
  </div>
  <!-- RIGHT -->
  <div class="col">
    <div class="phead"><div class="phead-t">üìÑ Script Output</div><div style="display:flex;gap:5px"><button class="tbtn" id="ab-btn" style="display:none;font-size:.68rem;padding:4px 9px" onclick="generateABVariants()"><div class="spin" id="ab-spin" style="width:11px;height:11px;border-width:2px"></div><span id="ab-btn-txt">A/B Hooks</span></button><button class="tbtn" id="copy-btn" style="display:none" onclick="copyScript()">Copy</button></div></div>
    <div class="pscroll" id="s1out-body">
      <div id="s1placeholder" style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:8px;color:var(--m);text-align:center;padding:40px">
        <div style="font-size:2.5rem;opacity:.12">üìù</div>
        <div style="font-size:.84rem;max-width:200px;line-height:1.5">Fill in the topic and click Generate</div>
      </div>
      <div id="s1out" style="display:none"></div>
      <div id="ab-panel" style="display:none;border-top:1px solid var(--b);margin-top:10px;padding-top:12px">
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:.76rem;margin-bottom:4px;display:flex;align-items:center;gap:6px">üé£ Hook Variants <span class="pill act" style="font-size:.58rem">Pick one</span></div>
        <div style="font-size:.72rem;color:var(--m);margin-bottom:8px">Click a variant to use it as your hook</div>
        <div class="ab-wrap" id="ab-cards"></div>
      </div>
    </div>
    <div class="pfoot" id="s1next" style="display:none">
      <div class="next-cta" onclick="goStage(2)">
        <div><div class="nc-txt">Continue to Voiceover ‚Üí</div><div class="nc-sub">Script ready ‚Äî generate the audio track</div></div>
        <span style="color:var(--a);font-size:1.1rem">‚Ä∫</span>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STAGE 2: VOICEOVER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="stage" id="s2">
  <!-- LEFT -->
  <div class="col" style="border-right:1px solid var(--b);background:var(--s)">
    <div class="phead"><div class="phead-t">üéôÔ∏è Voice Settings</div><div class="pill pend" id="s2pill">Not generated</div></div>
    <div class="pscroll">
      <div class="sec"><label class="label">Script (from Stage 1)</label><textarea class="textarea" id="vo-script" rows="5" style="font-size:.79rem"></textarea></div>
      <div class="divider"></div>
      <!-- ElevenLabs API Key -->
      <div class="sec" id="el-key-sec">
        <label class="label">ElevenLabs API Key</label>
        <div style="display:flex;gap:6px">
          <input class="inp" id="el-api-key" type="password" placeholder="sk_..." style="flex:1;font-family:'DM Mono',monospace;font-size:.75rem">
          <button class="tbtn" onclick="saveELKey()" style="flex-shrink:0">Save</button>
        </div>
        <div id="el-key-status" style="font-size:.68rem;margin-top:5px;color:var(--m)">Enter your ElevenLabs API key ‚Äî free at elevenlabs.io</div>
      </div>
      <div class="divider"></div>
      <label class="label">Voice ‚Äî Male Narrators</label>
      <div class="vcgrid">
        <div class="vc on" onclick="selVoice(this,'pNInz6obpgDQGcFmaJgB')"><div class="vc-dot"></div><div class="vc-top"><div class="vc-av" style="background:linear-gradient(135deg,#1a3000,#0a1800)">üéô</div><div><div class="vc-name">Adam</div><div class="vc-meta">Deep ¬∑ Authoritative</div></div></div><div class="vc-tags2"><div class="vc-tag">Narrator</div></div></div>
        <div class="vc" onclick="selVoice(this,'ErXwobaYiN019PkySvjV')"><div class="vc-dot"></div><div class="vc-top"><div class="vc-av" style="background:linear-gradient(135deg,#001a3a,#000a1a)">üéô</div><div><div class="vc-name">Antoni</div><div class="vc-meta">Warm ¬∑ Storyteller</div></div></div><div class="vc-tags2"><div class="vc-tag">Narrator</div></div></div>
        <div class="vc" onclick="selVoice(this,'VR6AewLTigWG4xSOukaG')"><div class="vc-dot"></div><div class="vc-top"><div class="vc-av" style="background:linear-gradient(135deg,#2a0800,#150300)">üéô</div><div><div class="vc-name">Arnold</div><div class="vc-meta">Grounded ¬∑ Cinematic</div></div></div><div class="vc-tags2"><div class="vc-tag">Drama</div></div></div>
        <div class="vc" onclick="selVoice(this,'TxGEqnHWrfWFTfGW9XjX')"><div class="vc-dot"></div><div class="vc-top"><div class="vc-av" style="background:linear-gradient(135deg,#001a14,#00080a)">üéô</div><div><div class="vc-name">Josh</div><div class="vc-meta">Confident ¬∑ Engaging</div></div></div><div class="vc-tags2"><div class="vc-tag">Narrator</div></div></div>
        <div class="vc" onclick="selVoice(this,'yoZ06aMxZJJ28mfd3POQ')"><div class="vc-dot"></div><div class="vc-top"><div class="vc-av" style="background:linear-gradient(135deg,#1a1000,#0a0800)">üéô</div><div><div class="vc-name">Sam</div><div class="vc-meta">Raspy ¬∑ Dramatic</div></div></div><div class="vc-tags2"><div class="vc-tag">Drama</div></div></div>
        <div class="vc" onclick="selVoice(this,'onwK4e9ZLuTAKqWW03F9')"><div class="vc-dot"></div><div class="vc-top"><div class="vc-av" style="background:linear-gradient(135deg,#0a001a,#050010)">üéô</div><div><div class="vc-name">Daniel</div><div class="vc-meta">British ¬∑ Documentary</div></div></div><div class="vc-tags2"><div class="vc-tag">British</div></div></div>
      </div>
      <div class="divider"></div>
      <div class="sec">
        <div class="slider-hd"><label class="label" style="margin:0">Speaking Rate</label><span class="sv" id="vo-rate-v">0.95√ó</span></div>
        <input type="range" id="vo-rate" min="0.5" max="1.5" step="0.05" value="0.95" oninput="document.getElementById('vo-rate-v').textContent=parseFloat(this.value).toFixed(2)+'√ó'">
      </div>
    </div>
    <div class="pfoot"><button class="bigbtn" id="s2btn" onclick="generateVoiceover()"><div class="spin" id="s2spin"></div><span id="s2icon">üéôÔ∏è</span><span id="s2txt">Generate Voiceover</span></button></div>
  </div>
  <!-- RIGHT -->
  <div class="col">
    <div class="phead"><div class="phead-t">üéß Audio Preview</div><button class="tbtn" id="vo-dl" style="display:none" onclick="dlAudio()">‚¨á MP3</button></div>
    <div class="pscroll">
      <div class="wv-box"><canvas id="wv"></canvas><div class="wv-ph" id="wv-ph"><span style="opacity:.2;font-size:1.2rem">„Ä∞Ô∏è</span><span style="font-size:.76rem">Waveform after generation</span></div></div>
      <div class="player">
        <button class="play-btn" id="vo-play" disabled onclick="togglePlay()"><svg id="vo-play-icon" width="11" height="14" viewBox="0 0 11 14" fill="none"><path d="M1 1l9 6-9 6V1z" fill="#000"/></svg></button>
        <div class="player-info">
          <div class="player-name" id="vo-pname">No audio</div>
          <div class="prog-bg" onclick="seekAudio(event)" id="vo-pbg"><div class="prog-fill" id="vo-pfill"></div></div>
          <div class="player-time"><span id="vo-cur">0:00</span><span id="vo-tot">0:00</span></div>
        </div>
      </div>
      <div class="vostats">
        <div class="vostat"><div class="vostat-val" id="vstat-dur">‚Äî</div><div class="vostat-lbl">Duration</div></div>
        <div class="vostat"><div class="vostat-val" id="vstat-wds">‚Äî</div><div class="vostat-lbl">Words</div></div>
        <div class="vostat"><div class="vostat-val" id="vstat-voice">‚Äî</div><div class="vostat-lbl">Voice</div></div>
      </div>
      <div id="s2next" style="display:none">
        <div class="next-cta" onclick="goStage(3)">
          <div><div class="nc-txt">Continue to Video ‚Üí</div><div class="nc-sub">Audio ready ‚Äî render the video</div></div>
          <span style="color:var(--a);font-size:1.1rem">‚Ä∫</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STAGE 3: VIDEO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="stage" id="s3">
  <!-- LEFT settings -->
  <div class="col" style="border-right:1px solid var(--b);background:var(--s)">
    <div class="phead"><div class="phead-t">üé¨ Video Settings</div></div>
    <div class="pscroll">
      <div class="sec"><label class="label">Theme</label>
        <div class="tags" id="vid-theme">
          <div class="tag on" onclick="pt(this,'vid-theme');rfrC()">Dark Cinema</div>
          <div class="tag" onclick="pt(this,'vid-theme');rfrC()">Neon Grid</div>
          <div class="tag" onclick="pt(this,'vid-theme');rfrC()">Clean Bold</div>
          <div class="tag" onclick="pt(this,'vid-theme');rfrC()">Deep Space</div>
          <div class="tag" onclick="pt(this,'vid-theme');rfrC()">Fire</div>
        </div>
      </div>
      <div class="sec"><label class="label">Text Animation</label>
        <div class="tags" id="vid-anim">
          <div class="tag on" onclick="pt(this,'vid-anim')">Word by Word</div>
          <div class="tag" onclick="pt(this,'vid-anim')">Fade In</div>
          <div class="tag" onclick="pt(this,'vid-anim')">Rise Up</div>
          <div class="tag" onclick="pt(this,'vid-anim')">Typewriter</div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="sec">
        <div class="slider-hd"><label class="label" style="margin:0">Secs / Scene</label><span class="sv" id="sps-v">5s</span></div>
        <input type="range" id="sps" min="3" max="14" value="5" oninput="document.getElementById('sps-v').textContent=this.value+'s';parseScenes()">
      </div>
      <div class="sec">
        <div class="slider-hd"><label class="label" style="margin:0">Text Size</label><span class="sv" id="ts-v">100%</span></div>
        <input type="range" id="ts" min="65" max="145" value="100" oninput="document.getElementById('ts-v').textContent=this.value+'%';rfrC()">
      </div>
      <div class="sec">
        <div class="slider-hd"><label class="label" style="margin:0">Image Dim</label><span class="sv" id="dim-v">55%</span></div>
        <input type="range" id="dim" min="20" max="90" value="55" oninput="document.getElementById('dim-v').textContent=this.value+'%';rfrC()">
      </div>
      <div class="divider"></div>
      <!-- Captions -->
      <div class="tog-row"><div class="tog-label">üî§ Captions</div><div class="tog on" id="cap-tog" onclick="this.classList.toggle('on');rfrC()"></div></div>
      <div class="cap-grid" style="margin-bottom:8px">
        <div class="cap-card on" onclick="pickCap(this,'bold-bar')"><div class="cap-card-e">üì∫</div><div class="cap-card-l">Bold Bar</div></div>
        <div class="cap-card" onclick="pickCap(this,'word-pop')"><div class="cap-card-e">üí•</div><div class="cap-card-l">Word Pop</div></div>
        <div class="cap-card" onclick="pickCap(this,'karaoke')"><div class="cap-card-e">üé§</div><div class="cap-card-l">Karaoke</div></div>
        <div class="cap-card" onclick="pickCap(this,'tiktok')"><div class="cap-card-e">üì±</div><div class="cap-card-l">TikTok</div></div>
      </div>
      <div class="sec">
        <label class="label">Words per Caption</label>
        <div class="tags" id="cap-wpc">
          <div class="tag" onclick="pt(this,'cap-wpc');genCaps();rfrC()">3</div>
          <div class="tag on" onclick="pt(this,'cap-wpc');genCaps();rfrC()">5</div>
          <div class="tag" onclick="pt(this,'cap-wpc');genCaps();rfrC()">7</div>
        </div>
      </div>
      <div class="sec">
        <label class="label">Caption Position</label>
        <div class="tags" id="cap-pos">
          <div class="tag" onclick="pt(this,'cap-pos');rfrC()">Top</div>
          <div class="tag" onclick="pt(this,'cap-pos');rfrC()">Mid</div>
          <div class="tag on" onclick="pt(this,'cap-pos');rfrC()">Bottom</div>
        </div>
      </div>
      <div class="divider"></div>
      <!-- Music Bed -->
      <div class="tog-row"><div class="tog-label">üéµ Music Bed</div><div class="tog" id="music-tog" onclick="toggleMusicBed(this)"></div></div>
      <div id="music-panel" style="display:none">
        <div class="music-tracks" id="music-tracks">
          <div class="mtrack on" data-url="" onclick="selTrack(this,'none')"><div class="mt-dot"></div><div class="mt-info"><div class="mt-name">None / Silence</div><div class="mt-meta">No background music</div></div></div>
          <div class="mtrack" data-url="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" onclick="selTrack(this,'epic')"><div class="mt-dot"></div><div class="mt-info"><div class="mt-name">Epic Cinematic</div><div class="mt-meta">Orchestral ¬∑ Dramatic</div></div><div class="mt-bpm">120 BPM</div></div>
          <div class="mtrack" data-url="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" onclick="selTrack(this,'dark')"><div class="mt-dot"></div><div class="mt-info"><div class="mt-name">Dark Ambient</div><div class="mt-meta">Atmospheric ¬∑ Tension</div></div><div class="mt-bpm">85 BPM</div></div>
          <div class="mtrack" data-url="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3" onclick="selTrack(this,'upbeat')"><div class="mt-dot"></div><div class="mt-info"><div class="mt-name">Upbeat Energy</div><div class="mt-meta">Motivational ¬∑ Drive</div></div><div class="mt-bpm">128 BPM</div></div>
          <div class="mtrack" data-url="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3" onclick="selTrack(this,'lofi')"><div class="mt-dot"></div><div class="mt-info"><div class="mt-name">Lo-Fi Chill</div><div class="mt-meta">Relaxed ¬∑ Focus</div></div><div class="mt-bpm">90 BPM</div></div>
        </div>
        <div class="sec" style="margin-top:8px">
          <div class="slider-hd"><label class="label" style="margin:0">Music Volume</label><span class="sv" id="music-vol-v">25%</span></div>
          <input type="range" id="music-vol" min="0" max="100" value="25" oninput="document.getElementById('music-vol-v').textContent=this.value+'%';updateMusicVol()">
        </div>
        <div class="sec">
          <div class="tog-row" style="margin-bottom:0"><div style="font-size:.73rem;color:var(--m2)">ü¶Ü Auto-duck under voice</div><div class="tog on" id="duck-tog"></div></div>
        </div>
      </div>
      <div class="divider"></div>
      <div id="rendprog" style="display:none;margin-bottom:9px">
        <div class="vpbg"><div class="vpfill" id="lpfill"></div></div>
        <div style="display:flex;justify-content:space-between;font-family:'DM Mono',monospace;font-size:.6rem;color:var(--m);margin-top:3px"><span id="lplbl">Starting...</span><span id="lppct">0%</span></div>
      </div>
      <button class="bigbtn" id="render-btn" onclick="toggleRender()"><span id="ri">üé¨</span><span id="rt"> Render Video</span></button>
    </div>
  </div>
  <!-- CENTER canvas -->
  <div class="col">
    <div class="canvas-area" id="c3area">
      <div class="canvas-shell" id="c3shell">
        <canvas id="vc3" width="1280" height="720"></canvas>
        <div class="rec-badge" id="rec-badge">1280 √ó 720 ¬∑ 30fps</div>
        <div class="done-ov" id="done-ov">
          <div style="font-size:2.4rem">üé¨</div>
          <div class="done-title">Video Rendered!</div>
          <div class="done-sub" id="done-sub">Ready to export</div>
          <div class="done-btns">
            <button class="db" onclick="document.getElementById('done-ov').classList.remove('show');previewVid()">Preview</button>
            <button class="db p" onclick="dlWebM()">‚¨á WebM</button>
            <button class="db m" onclick="exportMP4()">‚¨á MP4</button>
          </div>
          <button class="db p" style="margin-top:4px;width:100%;max-width:220px" onclick="document.getElementById('done-ov').classList.remove('show');goStage(4)">‚Üí Make Thumbnail</button>
        </div>
      </div>
    </div>
    <div class="vid-prog">
      <div class="vpbg"><div class="vpfill" id="cpfill"></div></div>
      <div class="vpinfo"><span id="vplbl">Ready to render</span><span id="vppct">‚Äî</span></div>
    </div>
    <div class="sbar">
      <div class="si"><div class="sd g" id="st-dot"></div><span>Status:</span><span class="sv2" id="st-st">Ready</span></div>
      <div class="ssep"></div><div class="si"><span>Scenes:</span><span class="sv2" id="st-sc">0</span></div>
      <div class="ssep"></div><div class="si"><span>Dur:</span><span class="sv2" id="st-dur">0:00</span></div>
      <div class="ssep"></div><div class="si"><span>B-roll:</span><span class="sv2" id="st-br">0/0</span></div>
      <div class="ssep"></div><div class="si"><span>Audio:</span><span class="sv2" id="st-au">None</span></div>
      <div class="ssep"></div><div class="si"><span>Size:</span><span class="sv2" id="st-sz">‚Äî</span></div>
    </div>
  </div>
  <!-- RIGHT scenes + export -->
  <div class="col" style="border-left:1px solid var(--b);background:var(--s)">
    <div class="phead"><div class="phead-t">Scenes & Export</div><button class="tbtn" style="padding:3px 7px;font-size:.62rem" onclick="fetchAllBroll()">‚ö° Auto B-roll</button></div>
    <div class="pscroll">
      <div class="mp4prog" id="mp4prog"><div class="mp4prog-t">‚è≥ Encoding MP4...</div><div class="mp4bg"><div class="mp4fill" id="mp4fill"></div></div><div class="mp4lbl" id="mp4lbl">Initializing...</div></div>
      <label class="label">Scenes</label>
      <div id="sc-list"></div>
      <div class="divider"></div>
      <label class="label">Export</label>
      <div class="export-card"><div class="ec-t">üìπ WebM</div><div class="ec-d">Instant. Chrome, Firefox, VLC.</div><button class="ec-btn" id="exp-webm" disabled onclick="dlWebM()">‚¨á WebM</button></div>
      <div class="export-card"><div class="ec-t">üé¨ MP4 <span style="font-size:.58rem;padding:1px 5px;background:rgba(71,180,255,.1);border:1px solid rgba(71,180,255,.2);color:var(--a3);border-radius:100px">WebCodecs</span></div><div class="ec-d">H.264 MP4 ‚Äî YouTube, everywhere.</div><button class="ec-btn mp4" id="exp-mp4" disabled onclick="exportMP4()">‚¨á Export MP4</button></div>
      <div class="export-card" style="border-color:rgba(255,0,0,.2);background:rgba(255,0,0,.04)"><div class="ec-t" style="color:#ff4444">‚ñ∂ YouTube</div><div class="ec-d">Upload directly to your channel.</div><button class="ec-btn" id="yt-upload-btn-s3" style="background:rgba(255,0,0,.15);border-color:rgba(255,0,0,.3);color:#ff6666" onclick="openYTModal()">‚¨Ü Upload to YouTube</button></div>
      <div class="divider"></div>
      <label class="label">Tools</label>
      <div style="display:flex;flex-direction:column;gap:5px">
        <button class="tbtn" style="width:100%;display:flex;align-items:center;gap:6px;justify-content:flex-start;padding:8px 11px" onclick="openSRTModal()">üìù Export SRT Subtitles</button>
        <button class="tbtn" style="width:100%;display:flex;align-items:center;gap:6px;justify-content:flex-start;padding:8px 11px" onclick="openChaptersModal()">üìë Generate YT Chapters</button>
        <button class="tbtn" style="width:100%;display:flex;align-items:center;gap:6px;justify-content:flex-start;padding:8px 11px" onclick="openAnalyticsModal()">üìä Analytics Preview</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STAGE 4: THUMBNAIL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="stage" id="s4">
  <!-- LEFT -->
  <div class="col" style="border-right:1px solid var(--b);background:var(--s)">
    <div class="phead"><div class="phead-t">üñºÔ∏è Thumbnail Settings</div><button class="tbtn" style="padding:3px 7px;font-size:.62rem" onclick="genAIBG()">‚ö° AI BG</button></div>
    <div class="pscroll">
      <div class="sec"><label class="label">Headline</label><textarea class="textarea" id="th-headline" rows="2" oninput="syncTLayers();dbrT()">THEY NEVER TALK ABOUT THIS</textarea></div>
      <div class="sec"><label class="label">Sub Text</label><input class="inp" id="th-sub" type="text" oninput="syncTLayers();dbrT()"></div>
      <div class="sec"><label class="label">Badge / Number</label><input class="inp" id="th-badge" type="text" placeholder="7 or #1 or leave blank" oninput="dbrT()" value="7"></div>
      <div class="divider"></div>
      <div class="sec"><label class="label">Layout</label><div class="layout-grid" id="th-layouts"></div></div>
      <div class="divider"></div>
      <div class="sec"><label class="label">Accent Color</label>
        <div class="swatch-row" id="th-swatches">
          <div class="swatch on" style="background:#c6ff47" data-c="#c6ff47" onclick="pickAcc(this)"></div>
          <div class="swatch" style="background:#ff6b35" data-c="#ff6b35" onclick="pickAcc(this)"></div>
          <div class="swatch" style="background:#47b4ff" data-c="#47b4ff" onclick="pickAcc(this)"></div>
          <div class="swatch" style="background:#ffd700" data-c="#ffd700" onclick="pickAcc(this)"></div>
          <div class="swatch" style="background:#ff3d6b" data-c="#ff3d6b" onclick="pickAcc(this)"></div>
          <div class="swatch" style="background:#b47fff" data-c="#b47fff" onclick="pickAcc(this)"></div>
          <div class="swatch" style="background:#00ffd5" data-c="#00ffd5" onclick="pickAcc(this)"></div>
        </div>
      </div>
      <div class="sec"><label class="label">Headline Font</label>
        <div class="tags" id="th-font">
          <div class="tag on" data-font="Bebas Neue" onclick="pt(this,'th-font');dbrT()">Bebas</div>
          <div class="tag" data-font="Anton" onclick="pt(this,'th-font');dbrT()">Anton</div>
          <div class="tag" data-font="Oswald" onclick="pt(this,'th-font');dbrT()">Oswald</div>
          <div class="tag" data-font="Syne" onclick="pt(this,'th-font');dbrT()">Syne</div>
        </div>
      </div>
      <div class="sec"><label class="label">Background</label>
        <div class="tags" id="th-bg">
          <div class="tag on" onclick="pt(this,'th-bg');dbrT()">AI Generated</div>
          <div class="tag" onclick="pt(this,'th-bg');dbrT()">Gradient</div>
          <div class="tag" onclick="pt(this,'th-bg');dbrT()">Upload Photo</div>
        </div>
      </div>
      <div class="sec">
        <div class="slider-hd"><label class="label" style="margin:0">Darkness</label><span class="sv" id="tod-v">60%</span></div>
        <input type="range" id="tod" min="10" max="92" value="60" oninput="document.getElementById('tod-v').textContent=this.value+'%';dbrT()">
      </div>
      <div class="sec"><label class="label">AI Style</label>
        <div class="tags" id="th-aibg">
          <div class="tag on" onclick="pt(this,'th-aibg')">Cinematic</div>
          <div class="tag" onclick="pt(this,'th-aibg')">Dramatic</div>
          <div class="tag" onclick="pt(this,'th-aibg')">Abstract</div>
          <div class="tag" onclick="pt(this,'th-aibg')">Dark Luxury</div>
          <div class="tag" onclick="pt(this,'th-aibg')">Nature Epic</div>
        </div>
      </div>
      <div style="margin-top:8px"><button class="bigbtn" id="aibg-btn" onclick="genAIBG()"><div class="spin" id="aibg-spin"></div><span id="aibg-icon">ü§ñ</span><span id="aibg-txt">Generate AI Background</span></button></div>
    </div>
  </div>
  <!-- CENTER canvas -->
  <div class="col">
    <div class="tc-area" id="tc-area">
      <div class="tc-shell" id="tc-shell">
        <canvas id="tc" width="1280" height="720"></canvas>
        <div class="shimmer" id="shimmer"></div>
      </div>
    </div>
    <div style="padding:6px 14px 3px;border-top:1px solid var(--b);background:var(--s);font-family:'Syne',sans-serif;font-weight:700;font-size:.7rem;color:var(--m);flex-shrink:0">Color Variants</div>
    <div class="var-strip" id="var-strip"></div>
    <div class="tc-foot">
      <span class="tc-info">1280 √ó 720 ¬∑ PNG</span>
      <span class="tc-info" style="margin-left:auto" id="th-bg-status">Gradient</span>
    </div>
  </div>
  <!-- RIGHT layers -->
  <div class="col" style="border-left:1px solid var(--b);background:var(--s)">
    <div class="phead"><div class="phead-t">‚úèÔ∏è Text Layers</div>
      <div style="display:flex;gap:5px">
        <button class="tbtn" style="padding:3px 7px;font-size:.62rem" onclick="addTLayer()">+ Add</button>
        <button class="tbtn" style="padding:3px 7px;font-size:.62rem" onclick="randomizeThumbnail()">üé≤</button>
      </div>
    </div>
    <div class="pscroll" id="tlayers-panel"></div>
    <div class="pfoot" style="display:flex;flex-direction:column;gap:7px">
      <button class="tbtn" style="width:100%;text-align:center;justify-content:center;display:flex;border-color:rgba(255,255,255,.18)" onclick="copyTCanvas()">üìã Copy PNG</button>
      <button class="bigbtn" onclick="exportThumbnail()">‚¨á Export 1280√ó720 PNG</button>
      <button class="bigbtn" style="background:#ff0000;margin-top:2px" onclick="openYTModal()">‚ñ∂ Upload to YouTube</button>
    </div>
  </div>
</div>

</div><!-- /app -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SRT MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="feature-modal" id="srt-modal">
  <div class="fmod-box">
    <button onclick="document.getElementById('srt-modal').classList.remove('open')" style="position:absolute;top:14px;right:16px;background:none;border:none;color:var(--m2);font-size:1.2rem;cursor:pointer">‚úï</button>
    <div class="fmod-title">üìù SRT Subtitle File</div>
    <div class="fmod-sub">Ready to import into YouTube Studio, Premiere, DaVinci, etc.</div>
    <div class="fmod-code" id="srt-preview"></div>
    <div style="display:flex;gap:8px">
      <button class="bigbtn" style="flex:1" onclick="downloadSRT()">‚¨á Download .srt</button>
      <button class="tbtn" onclick="copySRT()">üìã Copy</button>
      <button class="tbtn" onclick="document.getElementById('srt-modal').classList.remove('open')">Close</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CHAPTERS MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="feature-modal" id="chapters-modal">
  <div class="fmod-box">
    <button onclick="document.getElementById('chapters-modal').classList.remove('open')" style="position:absolute;top:14px;right:16px;background:none;border:none;color:var(--m2);font-size:1.2rem;cursor:pointer">‚úï</button>
    <div class="fmod-title">üìë YouTube Chapters</div>
    <div class="fmod-sub">Paste this into your YouTube video description to enable chapter markers.</div>
    <div class="fmod-code" id="chapters-preview"></div>
    <div style="display:flex;gap:8px">
      <button class="bigbtn" style="flex:1" onclick="copyChapters()">üìã Copy to Clipboard</button>
      <button class="tbtn" onclick="document.getElementById('chapters-modal').classList.remove('open')">Close</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ANALYTICS MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="feature-modal" id="analytics-modal">
  <div class="fmod-box">
    <button onclick="document.getElementById('analytics-modal').classList.remove('open')" style="position:absolute;top:14px;right:16px;background:none;border:none;color:var(--m2);font-size:1.2rem;cursor:pointer">‚úï</button>
    <div class="fmod-title">üìä Analytics Preview</div>
    <div class="fmod-sub">Predicted performance based on script, title, and video structure.</div>
    <div class="analytics-grid" id="analytics-grid"></div>
    <div style="background:var(--s2);border:1px solid var(--b2);border-radius:8px;padding:13px;margin-bottom:14px">
      <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:.76rem;margin-bottom:8px;color:var(--m2)">üí° Suggestions</div>
      <div id="analytics-tips" style="font-size:.77rem;line-height:1.8;color:var(--m2)"></div>
    </div>
    <button class="tbtn" style="width:100%" onclick="document.getElementById('analytics-modal').classList.remove('open')">Close</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê YOUTUBE UPLOAD MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="yt-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:999;align-items:center;justify-content:center">
  <div style="background:#0d1017;border:1px solid rgba(255,255,255,.1);border-radius:14px;width:520px;max-width:95vw;max-height:90vh;overflow-y:auto;padding:28px;position:relative">
    <button onclick="closeYTModal()" style="position:absolute;top:14px;right:16px;background:none;border:none;color:var(--m2);font-size:1.2rem;cursor:pointer;line-height:1">‚úï</button>
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:20px">
      <div style="width:36px;height:36px;background:#ff0000;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0">‚ñ∂</div>
      <div><div style="font-family:'Syne',sans-serif;font-weight:800;font-size:1rem">Upload to YouTube</div><div style="font-size:.72rem;color:var(--m2);margin-top:1px">Publish directly to your channel</div></div>
    </div>

    <!-- Step 0: Client ID setup -->
    <div id="yt-step-setup">
      <div style="background:rgba(255,193,7,.06);border:1px solid rgba(255,193,7,.2);border-radius:8px;padding:12px 14px;margin-bottom:16px;font-size:.76rem;line-height:1.7;color:var(--m2)">
        <div style="font-family:'Syne',sans-serif;font-weight:700;color:var(--warn);margin-bottom:6px">‚öôÔ∏è One-time Setup Required</div>
        1. Go to <strong style="color:var(--t)">console.cloud.google.com</strong> ‚Üí Create a project<br>
        2. Enable <strong style="color:var(--t)">YouTube Data API v3</strong><br>
        3. Create credentials ‚Üí <strong style="color:var(--t)">OAuth 2.0 Client ID</strong> ‚Üí Web Application<br>
        4. Under <strong style="color:var(--t)">Authorized JavaScript Origins</strong> add:<br>
        <div style="margin:6px 0 2px 12px;padding:5px 10px;background:rgba(198,255,71,.07);border:1px solid rgba(198,255,71,.15);border-radius:5px;font-family:'DM Mono',monospace;font-size:.7rem;color:var(--a);user-select:all">https://arinzaay007.github.io</div>
        5. Paste your Client ID below
      </div>
      <label class="label">Google OAuth Client ID</label>
      <input class="inp" id="yt-client-id" type="text" placeholder="xxxxxxxx.apps.googleusercontent.com" style="margin-bottom:12px">
      <div style="display:flex;gap:8px">
        <button class="bigbtn" style="flex:1" onclick="ytConnect()"><span id="yt-conn-txt">üîó Connect Google Account</span></button>
        <button class="tbtn" onclick="closeYTModal()">Cancel</button>
      </div>
    </div>

    <!-- Step 1: Upload form (shown after auth) -->
    <div id="yt-step-form" style="display:none">
      <div style="display:flex;align-items:center;gap:8px;background:rgba(52,211,153,.07);border:1px solid rgba(52,211,153,.2);border-radius:7px;padding:8px 12px;margin-bottom:16px;font-size:.75rem;color:var(--ok)">
        <span>‚úì</span><span id="yt-connected-as">Connected</span>
      </div>
      <div class="sec"><label class="label">Title</label><input class="inp" id="yt-title" type="text" maxlength="100"></div>
      <div class="sec"><label class="label">Description</label><textarea class="textarea" id="yt-desc" rows="4" style="resize:vertical"></textarea></div>
      <div class="sec"><label class="label">Tags <span style="color:var(--m);font-weight:400;text-transform:none">(comma separated)</span></label><input class="inp" id="yt-tags" type="text" placeholder="youtube, faceless, automation"></div>
      <div class="sec"><label class="label">Privacy</label>
        <select class="sel" id="yt-privacy" onchange="toggleSchedule()">
          <option value="private">üîí Private</option>
          <option value="unlisted">üîó Unlisted</option>
          <option value="public">üåç Public</option>
          <option value="scheduled">üìÖ Scheduled (Public)</option>
        </select>
      </div>
      <div class="sec" id="yt-schedule-row" style="display:none">
        <label class="label">Publish Date & Time</label>
        <input class="inp" type="datetime-local" id="yt-schedule-dt" style="color-scheme:dark">
      </div>
      <div class="sec"><label class="label">Video File</label>
        <div id="yt-video-status" style="font-size:.76rem;padding:8px 10px;background:var(--s2);border:1px solid var(--b2);border-radius:7px;color:var(--m2)">No video rendered yet ‚Äî render in Stage 3 first</div>
      </div>
      <div class="sec"><label class="label">Thumbnail <span style="color:var(--m);font-weight:400;text-transform:none">(from Stage 4)</span></label>
        <div id="yt-thumb-status" style="font-size:.76rem;padding:8px 10px;background:var(--s2);border:1px solid var(--b2);border-radius:7px;color:var(--m2)">No thumbnail ‚Äî export in Stage 4 first</div>
      </div>
      <!-- Upload progress -->
      <div id="yt-prog-wrap" style="display:none;margin-bottom:12px">
        <div style="background:var(--s3);border-radius:4px;height:6px;overflow:hidden;margin-bottom:6px"><div id="yt-prog-fill" style="height:100%;background:#ff0000;width:0%;transition:width .3s;border-radius:4px"></div></div>
        <div style="display:flex;justify-content:space-between;font-family:'DM Mono',monospace;font-size:.62rem;color:var(--m2)"><span id="yt-prog-lbl">Uploading...</span><span id="yt-prog-pct">0%</span></div>
      </div>
      <div id="yt-result" style="display:none;background:rgba(52,211,153,.07);border:1px solid rgba(52,211,153,.2);border-radius:8px;padding:12px;margin-bottom:12px;font-size:.76rem">
        <div style="font-family:'Syne',sans-serif;font-weight:700;color:var(--ok);margin-bottom:4px">‚úì Uploaded successfully!</div>
        <a id="yt-result-link" href="#" target="_blank" style="color:var(--a3)">View on YouTube ‚Üí</a>
      </div>
      <div style="display:flex;gap:8px">
        <button class="bigbtn" id="yt-upload-go" style="flex:1;background:#ff0000" onclick="doYTUpload()"><div class="spin" id="yt-spin"></div><span id="yt-upload-txt">‚¨Ü Upload Video</span></button>
        <button class="tbtn" onclick="ytDisconnect()">Disconnect</button>
      </div>
    </div>
  </div>
</div>

<div class="toasts" id="toasts"></div>
<audio id="bgaudio" preload="auto"></audio>
<canvas id="offsc" style="display:none" width="1280" height="720"></canvas>
<input type="file" id="bg-upload" accept="image/*" style="display:none" onchange="loadBGPhoto(this.files[0])">

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GLOBAL STATE ‚Äî shared across all stages
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const G = {
  topic:     '',
  scriptText:'',
  audioBlob: null,
  audioUrl:  null,
  voice:     'Brian',
};

let curStage = 1;
const stageDone = {1:false,2:false,3:false,4:false};

// ‚îÄ‚îÄ Stage 3 state ‚îÄ‚îÄ
const V = { scenes:[], images:{}, prompts:{}, totalDur:0, isRendering:false, mediaRecorder:null, chunks:[], webmBlob:null, animId:null, prevAnimId:null, particles:[], mp4Encoding:false };
let captions=[], capStyle='bold-bar';

// ‚îÄ‚îÄ Stage 4 state ‚îÄ‚îÄ
const T = {
  bgImage:null, accent:'#c6ff47', activeLayout:0,
  layers:[
    {id:1,type:'headline',text:'THEY NEVER TALK ABOUT THIS',font:'Bebas Neue',size:130,color:'#ffffff',shadow:true,outline:false,x:0.05,y:0.44,align:'left',upper:true},
    {id:2,type:'sub',text:'What the Rich Keep Hidden',font:'DM Sans',size:46,color:'#c6ff47',shadow:false,outline:false,x:0.05,y:0.60,align:'left',upper:false},
    {id:3,type:'badge',text:'7',font:'Bebas Neue',size:175,color:'#ffffff',shadow:false,outline:false,x:0.79,y:0.56,align:'center',upper:false},
  ],
  nextId:4, activeId:1, isGenerating:false, renderTimer:null,
};

const audio = document.getElementById('bgaudio');
const vc3   = document.getElementById('vc3');
const ctx3  = vc3.getContext('2d');
const tc    = document.getElementById('tc');
const tctx  = tc.getContext('2d');
const offsc = document.getElementById('offsc');
const offCtx= offsc.getContext('2d');

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goStage(n) {
  if (n<1||n>4) return;
  curStage = n;
  document.querySelectorAll('.stage').forEach(s=>s.classList.remove('active'));
  document.getElementById(`s${n}`).classList.add('active');
  document.querySelectorAll('.pstep').forEach((s,i)=>{ s.classList.toggle('active',i+1===n); });
  document.getElementById('prev-btn').disabled = n===1;
  const nxt = {1:'Next: Voiceover ‚Ä∫',2:'Next: Video ‚Ä∫',3:'Next: Thumbnail ‚Ä∫',4:'Export Done ‚úì'};
  document.getElementById('next-btn').textContent = nxt[n];
  document.getElementById('global-status').textContent = `Stage ${n} of 4`;
  if (n===2) syncToVO();
  if (n===3) { parseScenes(); setTimeout(()=>{scaleV();rfrC();},80); }
  if (n===4) { syncToThumb(); setTimeout(()=>{scaleTc();renderThumb();buildVariants();buildTLayersPanel();},80); }
}
function markDone(n) {
  stageDone[n]=true;
  const pn=document.getElementById(`pn${n}`);
  pn.textContent='‚úì';
  document.getElementById(`ps${n}`).classList.add('done');
}
function pt(el,gid){document.getElementById(gid).querySelectorAll('.tag').forEach(t=>t.classList.remove('on'));el.classList.add('on');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STAGE 1 ‚Äî SCRIPT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function generateScript() {
  const topic=document.getElementById('g-topic').value.trim();
  if(!topic){toast('Enter a topic first!','err');return;}
  G.topic=topic;
  const niche=document.getElementById('g-niche').value;
  const tone=document.querySelector('#g-tone .tag.on')?.textContent||'Engaging';
  const hook=document.querySelector('#g-hook .tag.on')?.textContent||'Bold Statement';
  const dur=document.getElementById('g-dur').value;
  const notes=document.getElementById('g-notes').value;

  setBL('s1btn','s1spin','s1icon','s1txt','Writing...',true);
  document.getElementById('s1placeholder').style.display='flex';
  document.getElementById('s1out').style.display='none';
  document.getElementById('s1next').style.display='none';
  document.getElementById('copy-btn').style.display='none';

  const prompt=`You are an expert YouTube scriptwriter for faceless automation channels.
Write a complete punchy retention-focused video script.
Topic: ${topic} | Niche: ${niche} | Tone: ${tone} | Hook: ${hook} | Duration: ${dur} min
${notes?'Notes: '+notes:''}
Use these section labels on their own lines: [TITLE] [HOOK] [INTRO] [MAIN CONTENT] [CTA] [SEO TAGS]
Write full script text under each section. Be specific and punchy.`;

  try {
    const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1400,messages:[{role:'user',content:prompt}]})});
    const d=await res.json();
    renderScript(d.content?.[0]?.text||'');
  } catch(e) {
    renderScript(`[TITLE]\n${topic}: What Nobody Tells You\n\n[HOOK]\nWhat if everything you've been told about ${topic} is completely wrong? In the next ${dur} minutes, I'm going to show you what the top 1% actually do ‚Äî and why 95% of people never figure it out.\n\n[INTRO]\nWelcome back. Today we're breaking down ${topic} ‚Äî and I'm not giving you the same recycled advice you've heard a thousand times.\n\n[MAIN CONTENT]\nHere's what separates people who get results from everyone else. It's not talent, it's not luck ‚Äî it's a specific set of behaviours that compound quietly over time.\n\nMost people focus on the wrong things. They chase tactics instead of systems. They want shortcuts instead of leverage. That's exactly why they stay stuck.\n\nThe framework is deceptively simple, but the execution is where most people quit. Step one: protect your mornings. The first two hours of the day are sacred ‚Äî no phone, no email, just deep work.\n\nStep two: invest before you spend. Every wealthy person pays themselves first, automatically, before a single bill is paid.\n\nStep three: build systems, not willpower. Willpower depletes. Systems run on autopilot.\n\n[CTA]\nIf this changed how you think, smash that like button ‚Äî it genuinely helps. Subscribe so you never miss these breakdowns.\n\n[SEO TAGS]\n${topic}, wealth, success, how to, mindset, 2025`);
    toast('Demo script (AI unavailable)','info');
  }
  setBL('s1btn','s1spin','s1icon','s1txt','Regenerate',false);
}

function renderScript(text) {
  const SECS=[{k:'[TITLE]',l:'YouTube Title',c:'var(--a)'},{k:'[HOOK]',l:'Hook (0‚Äì30s)',c:'var(--a2)'},{k:'[INTRO]',l:'Introduction',c:'var(--a3)'},{k:'[MAIN CONTENT]',l:'Main Script',c:'var(--a)'},{k:'[CTA]',l:'Call to Action',c:'var(--a2)'},{k:'[SEO TAGS]',l:'SEO Tags',c:'var(--ok)'}];
  const out=document.getElementById('s1out'); out.innerHTML='';
  SECS.forEach((s,i)=>{
    const idx=text.indexOf(s.k); if(idx===-1)return;
    const ends=SECS.slice(i+1).map(ns=>text.indexOf(ns.k)).filter(n=>n>idx);
    const content=text.substring(idx+s.k.length,ends.length?Math.min(...ends):text.length).trim();
    const div=document.createElement('div'); div.className='s1-out-section';
    div.innerHTML=`<div class="s1-sec-label" style="color:${s.c}">${s.l}</div><div class="s1-sec-text">${content.replace(/\n/g,'<br>')}</div>`;
    out.appendChild(div);
  });
  if(!out.children.length) out.innerHTML=`<div class="s1-out-section"><div class="s1-sec-text">${text.replace(/\n/g,'<br>')}</div></div>`;

  // Extract voiceover text
  const mainM=text.match(/\[MAIN CONTENT\]([\s\S]*?)(\[CTA\]|$)/i);
  const hookM=text.match(/\[HOOK\]([\s\S]*?)(\[INTRO\]|$)/i);
  const introM=text.match(/\[INTRO\]([\s\S]*?)(\[MAIN\]|$)/i);
  G.scriptText=[hookM?.[1]?.trim(),introM?.[1]?.trim(),mainM?.[1]?.trim()].filter(Boolean).join('\n\n')||text;

  document.getElementById('s1placeholder').style.display='none';
  document.getElementById('s1out').style.display='block';
  document.getElementById('copy-btn').style.display='block';
  document.getElementById('ab-btn').style.display='flex';
  document.getElementById('ab-panel').style.display='none';
  document.getElementById('s1pill').className='pill ok'; document.getElementById('s1pill').textContent='‚úì Ready';
  document.getElementById('s1next').style.display='block';
  markDone(1);
  toast('Script ready! ‚ú®','ok');
}

function copyScript(){navigator.clipboard.writeText(document.getElementById('s1out').innerText).then(()=>toast('Copied! üìã','ok'));}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STAGE 2 ‚Äî VOICEOVER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let voPlaying=false, voWaveData=null, voAnimId=null;

function syncToVO(){
  if(G.scriptText) document.getElementById('vo-script').value=G.scriptText;
}
function selVoice(el,name){document.querySelectorAll('.vc').forEach(c=>c.classList.remove('on'));el.classList.add('on');G.voice=name;}

// Split text into sentence-aware chunks under maxChars each
function chunkText(text, maxChars=2900){
  const sentences = text.match(/[^.!?\n]+[.!?\n]*/g) || [text];
  const chunks = [];
  let cur = '';
  for(const s of sentences){
    const trimmed = s.trim();
    if(!trimmed) continue;
    if(trimmed.length > maxChars){
      if(cur){chunks.push(cur.trim());cur='';}
      for(let i=0;i<trimmed.length;i+=maxChars) chunks.push(trimmed.slice(i,i+maxChars));
      continue;
    }
    if((cur+' '+trimmed).length > maxChars){
      if(cur) chunks.push(cur.trim());
      cur = trimmed;
    } else {
      cur = cur ? cur+' '+trimmed : trimmed;
    }
  }
  if(cur.trim()) chunks.push(cur.trim());
  return chunks;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ELEVENLABS TTS ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const EL_VOICES = {
  'pNInz6obpgDQGcFmaJgB': 'Adam',
  'ErXwobaYiN019PkySvjV': 'Antoni',
  'VR6AewLTigWG4xSOukaG': 'Arnold',
  'TxGEqnHWrfWFTfGW9XjX': 'Josh',
  'yoZ06aMxZJJ28mfd3POQ': 'Sam',
  'onwK4e9ZLuTAKqWW03F9': 'Daniel',
};

function saveELKey() {
  const key = document.getElementById('el-api-key').value.trim();
  if(!key){ toast('Paste your API key first','err'); return; }
  localStorage.setItem('el_api_key', key);
  document.getElementById('el-key-status').textContent = '‚úì Key saved';
  document.getElementById('el-key-status').style.color = 'var(--ok)';
  toast('ElevenLabs key saved ‚úì','ok');
}

function getELKey() {
  return localStorage.getItem('el_api_key') || document.getElementById('el-api-key').value.trim();
}

// Load saved key on page load
function initELKey() {
  const saved = localStorage.getItem('el_api_key');
  if(saved) {
    document.getElementById('el-api-key').value = saved;
    document.getElementById('el-key-status').textContent = '‚úì Key loaded';
    document.getElementById('el-key-status').style.color = 'var(--ok)';
  }
}

async function generateVoiceover() {
  const text = (document.getElementById('vo-script').value || G.scriptText || '').trim();
  if(!text){ toast('No script ‚Äî complete Stage 1 first!','err'); return; }

  const apiKey = getELKey();
  if(!apiKey){ toast('Add your ElevenLabs API key first','err'); document.getElementById('el-api-key').focus(); return; }

  setBL('s2btn','s2spin','s2icon','s2txt','Generating...',true);
  document.getElementById('wv-ph').style.display='flex';
  audio.pause(); audio.src='';
  if(G.audioUrl) URL.revokeObjectURL(G.audioUrl);
  G.audioBlob=null; G.audioUrl=null;
  document.getElementById('vo-pfill').style.width='0%';
  document.getElementById('vo-play').disabled=true;

  const voiceId = G.voice || 'pNInz6obpgDQGcFmaJgB';
  const voiceName = EL_VOICES[voiceId] || voiceId;
  const rate = parseFloat(document.getElementById('vo-rate').value) || 0.95;
  // ElevenLabs stability/similarity settings
  const stability = Math.max(0, Math.min(1, 1.5 - rate)); // slower = more stable
  const similarity = 0.80;

  try {
    // Split into chunks to handle long scripts (ElevenLabs max ~5000 chars per call)
    const chunks = chunkText(text, 4800);
    const totalChunks = chunks.length;
    const blobs = [];

    for(let i = 0; i < totalChunks; i++) {
      if(totalChunks > 1) document.getElementById('s2txt').textContent = `Part ${i+1}/${totalChunks}‚Ä¶`;

      const res = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`, {
        method: 'POST',
        headers: {
          'xi-api-key': apiKey,
          'Content-Type': 'application/json',
          'Accept': 'audio/mpeg',
        },
        body: JSON.stringify({
          text: chunks[i],
          model_id: 'eleven_monolingual_v1',
          voice_settings: { stability, similarity_boost: similarity }
        })
      });

      if(res.status === 401) throw new Error('Invalid API key ‚Äî check your ElevenLabs key');
      if(res.status === 429) throw new Error('Rate limit hit ‚Äî wait a moment and try again');
      if(!res.ok) { const e = await res.text(); throw new Error(`ElevenLabs ${res.status}: ${e}`); }

      const blob = await res.blob();
      if(blob.size < 500) throw new Error('Empty audio returned');
      blobs.push(blob);
    }

    // Merge all chunks into one blob
    const finalBlob = blobs.length === 1 ? blobs[0] : new Blob(blobs, { type: 'audio/mpeg' });
    G.audioBlob = finalBlob;
    G.audioUrl = URL.createObjectURL(finalBlob);
    audio.src = G.audioUrl;
    await new Promise((ok,fail) => { audio.onloadedmetadata=ok; audio.onerror=fail; setTimeout(ok,5000); });

    const dur = audio.duration || 0;
    const wds = text.split(/\s+/).length;
    document.getElementById('vstat-dur').textContent = ft(dur);
    document.getElementById('vstat-wds').textContent = wds.toLocaleString();
    document.getElementById('vstat-voice').textContent = voiceName;
    document.getElementById('vo-tot').textContent = ft(dur);
    document.getElementById('vo-pname').textContent = `${voiceName} ‚Äî ready${totalChunks>1?' ('+totalChunks+' parts)':''}`;
    document.getElementById('vo-play').disabled = false;
    document.getElementById('vo-dl').style.display = 'block';
    document.getElementById('s2next').style.display = 'block';
    document.getElementById('wv-ph').style.display = 'none';
    document.getElementById('s2pill').className='pill ok'; document.getElementById('s2pill').textContent='‚úì Ready';
    document.getElementById('st-au').textContent = voiceName;
    markDone(2);
    await drawWaveform(finalBlob);
    toast(`Voiceover ready! ${ft(dur)} ¬∑ ${wds} words ¬∑ ${voiceName} ‚ú®`,'ok');

  } catch(e) {
    toast('TTS failed: ' + e.message, 'err');
    document.getElementById('wv-ph').style.display='flex';
  }
  setBL('s2btn','s2spin','s2icon','s2txt','Regenerate',false);
}

async function drawWaveform(blob){
  const wvc=document.getElementById('wv'),wctx=wvc.getContext('2d');
  wvc.width=wvc.offsetWidth*devicePixelRatio;wvc.height=wvc.offsetHeight*devicePixelRatio;
  wctx.scale(devicePixelRatio,devicePixelRatio);
  const W=wvc.offsetWidth,H=wvc.offsetHeight;
  try{const ab=await blob.arrayBuffer();const ac=new(window.AudioContext||window.webkitAudioContext)();const buf=await ac.decodeAudioData(ab);voWaveData=buf.getChannelData(0);ac.close();}
  catch(e){voWaveData=Array.from({length:200},()=>Math.random()*.8+.1);}
  const N=180,step=Math.floor(voWaveData.length/N),peaks=[];
  for(let i=0;i<N;i++){let mx=0;for(let j=0;j<step;j++)mx=Math.max(mx,Math.abs(voWaveData[i*step+j]||0));peaks.push(mx);}
  cancelAnimationFrame(voAnimId);
  function drawW(){
    const p=audio.duration?audio.currentTime/audio.duration:0;
    wctx.clearRect(0,0,W,H);
    const bw=(W/N)*.55,gap=(W/N)*.45;
    peaks.forEach((pk,i)=>{const x=i*(bw+gap),bh=Math.max(2,pk*H*.88),played=x<W*p;wctx.fillStyle=played?`rgba(198,255,71,${.25+pk*.75})`:`rgba(255,255,255,${.06+pk*.14})`;wctx.beginPath();if(wctx.roundRect)wctx.roundRect(x,H/2-bh/2,bw,bh,1.5);else wctx.rect(x,H/2-bh/2,bw,bh);wctx.fill();});
    if(p>0){wctx.fillStyle='rgba(198,255,71,.8)';wctx.fillRect(W*p-1,0,2,H);}
    voAnimId=requestAnimationFrame(drawW);
  }drawW();
}

audio.addEventListener('timeupdate',()=>{if(!audio.duration)return;const p=audio.currentTime/audio.duration;document.getElementById('vo-pfill').style.width=(p*100)+'%';document.getElementById('vo-cur').textContent=ft(audio.currentTime);});
audio.addEventListener('ended',()=>{voPlaying=false;setPlayIcon(false);});
audio.addEventListener('play',()=>{voPlaying=true;setPlayIcon(true);});
audio.addEventListener('pause',()=>{voPlaying=false;setPlayIcon(false);});
function togglePlay(){if(!G.audioUrl)return;voPlaying?audio.pause():audio.play();}
function setPlayIcon(pl){document.getElementById('vo-play-icon').innerHTML=pl?'<rect x="1" y="1" width="3.5" height="12" rx="1" fill="#000"/><rect x="6.5" y="1" width="3.5" height="12" rx="1" fill="#000"/>':'<path d="M1 1l9 6-9 6V1z" fill="#000"/>';}
function seekAudio(e){if(!audio.duration)return;const r=document.getElementById('vo-pbg').getBoundingClientRect();audio.currentTime=((e.clientX-r.left)/r.width)*audio.duration;}
function dlAudio(){if(!G.audioBlob)return;const a=document.createElement('a');a.href=URL.createObjectURL(G.audioBlob);a.download=`vo-${G.voice}-${Date.now()}.mp3`;a.click();toast('MP3 downloading üéôÔ∏è','ok');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STAGE 3 ‚Äî VIDEO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const THEMES={
  'Dark Cinema':{bg1:'#04060d',bg2:'#0c1224',acc:'#c6ff47',txt:'#fff',bars:true, grid:false,vig:true, ptcl:true, pc:'rgba(198,255,71,.5)'},
  'Neon Grid':  {bg1:'#02050e',bg2:'#050916',acc:'#47b4ff',txt:'#fff',bars:false,grid:true, vig:false,ptcl:false,pc:''},
  'Clean Bold': {bg1:'#f8f9fc',bg2:'#e8ecf5',acc:'#0a0a0a',txt:'#0a0a0a',bars:true,grid:false,vig:false,ptcl:false,pc:''},
  'Deep Space': {bg1:'#010208',bg2:'#04061a',acc:'#b47fff',txt:'#fff',bars:false,grid:false,vig:true, ptcl:true, pc:'rgba(180,127,255,.55)'},
  'Fire':       {bg1:'#0f0400',bg2:'#200800',acc:'#ff6b35',txt:'#fff',bars:true, grid:false,vig:true, ptcl:true, pc:'rgba(255,107,53,.55)'},
};
const STOPS3=new Set(['the','a','an','and','or','but','in','on','at','to','for','of','with','is','are','was','were','be','been','this','that','it','they','we','you','i','have','do','will','not','so','as','by','from','about','than','when','who','what','how','if','can','just','all','more','most','some','any','also','very','get','let','us','them','back','out','into','over','after','such','each','every','many','much']);
const TOPICV={'money':'gold coins wealth abundance','wealth':'luxury penthouse city skyline','millionaire':'successful businessman luxury lifestyle','invest':'stock market growth charts','success':'mountain peak achievement dawn','habit':'morning routine sunrise discipline','mindset':'meditation clarity focus energy','history':'ancient ruins dramatic epic','tech':'futuristic neon circuit city','science':'laboratory light research','health':'athletic vitality nature energy','dark':'dramatic shadows noir cinematic','secret':'spotlight revelation dramatic','power':'lightning storm force energy','future':'futuristic city neon horizon'};
const STYLES3={cinematic:'cinematic photography, anamorphic lens, dramatic color grade, 4K',illustration:'digital illustration, concept art, artstation, vibrant',abstract:'abstract expressionism, bold geometry, vibrant palette',dark:'dark noir photography, deep shadows, cinematic tension','Nature Epic':'epic nature photography, golden hour, dramatic sky'};

function build3Prompt(text){
  const raw=text.toLowerCase().replace(/[^a-z\s]/g,' ').split(/\s+/);
  const words=raw.filter(w=>w.length>3&&!STOPS3.has(w));
  const scored=words.map(w=>{let sc=1;if(TOPICV[w])sc+=10;for(const k of Object.keys(TOPICV)){if(w.includes(k)||k.includes(w)){sc+=4;break;}}sc+=Math.min(w.length-3,4);return{w,sc};});
  scored.sort((a,b)=>b.sc-a.sc);
  const seen=new Set(),top=scored.filter(x=>{if(seen.has(x.w))return false;seen.add(x.w);return true;}).slice(0,4).map(x=>x.w);
  let exp='';for(const w of top){if(TOPICV[w]){exp=TOPICV[w];break;}for(const[k,v]of Object.entries(TOPICV)){if(w.includes(k)||k.includes(w)){exp=v;break;}}}
  const subj=exp||top.join(' ')||'dramatic cinematic scene';
  return[subj,'no text no words',STYLES3.cinematic].join(', ');
}

function initPtcl(theme){V.particles=[];if(!theme.ptcl)return;for(let i=0;i<65;i++)V.particles.push({x:Math.random()*1280,y:Math.random()*720,r:Math.random()*1.4+.4,vx:(Math.random()-.5)*.28,vy:-Math.random()*.32-.07,a:Math.random()*.5+.15});}
function tickPtcl(){V.particles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.a-=.0008;if(p.y<0||p.a<=0){p.x=Math.random()*1280;p.y=720;p.a=Math.random()*.5+.15;}});}
function getTheme(){return THEMES[document.querySelector('#vid-theme .tag.on')?.textContent||'Dark Cinema'];}
function getAnim(){return document.querySelector('#vid-anim .tag.on')?.textContent||'Word by Word';}

function renderVFrame(ctx2,si,prog){
  const W=1280,H=720,scene=V.scenes[si];if(!scene)return;
  const theme=getTheme(),anim=getAnim();
  const tsize=parseInt(document.getElementById('ts').value)/100;
  const dim=parseInt(document.getElementById('dim').value)/100;
  const bimg=V.images[si];
  ctx2.clearRect(0,0,W,H);
  if(bimg){const iR=bimg.naturalWidth/bimg.naturalHeight,cR=W/H;let sw,sh,sx,sy;if(iR>cR){sh=H;sw=H*iR;sy=0;sx=(W-sw)/2;}else{sw=W;sh=W/iR;sx=0;sy=(H-sh)/2;}ctx2.drawImage(bimg,sx,sy,sw,sh);ctx2.fillStyle=`rgba(0,0,0,${dim})`;ctx2.fillRect(0,0,W,H);ctx2.fillStyle=theme.bg1+'88';ctx2.fillRect(0,0,W,H);}
  else{const g=ctx2.createLinearGradient(0,0,W,H);g.addColorStop(0,theme.bg1);g.addColorStop(1,theme.bg2);ctx2.fillStyle=g;ctx2.fillRect(0,0,W,H);}
  if(theme.grid){ctx2.strokeStyle='rgba(71,180,255,.04)';ctx2.lineWidth=1;for(let x=0;x<W;x+=80){ctx2.beginPath();ctx2.moveTo(x,0);ctx2.lineTo(x,H);ctx2.stroke();}for(let y=0;y<H;y+=80){ctx2.beginPath();ctx2.moveTo(0,y);ctx2.lineTo(W,y);ctx2.stroke();}}
  if(theme.ptcl){tickPtcl();V.particles.forEach(p=>{ctx2.beginPath();ctx2.arc(p.x,p.y,p.r,0,Math.PI*2);ctx2.fillStyle=`rgba(${hrgb3(theme.pc)},${p.a})`;ctx2.fill();});}
  const glow=ctx2.createRadialGradient(W/2,H/2,0,W/2,H/2,W*.45);glow.addColorStop(0,theme.acc+'14');glow.addColorStop(1,'transparent');ctx2.fillStyle=glow;ctx2.fillRect(0,0,W,H);
  if(theme.vig){const vig=ctx2.createRadialGradient(W/2,H/2,H*.25,W/2,H/2,W*.78);vig.addColorStop(0,'transparent');vig.addColorStop(1,'rgba(0,0,0,.65)');ctx2.fillStyle=vig;ctx2.fillRect(0,0,W,H);}
  if(theme.bars){ctx2.fillStyle=theme.acc;ctx2.fillRect(64,0,4,H);ctx2.fillStyle=theme.acc+'30';ctx2.fillRect(74,0,2,H);}
  const tx=theme.bars?98:72,bfs=Math.round(54*tsize);
  ctx2.font=`800 ${bfs}px 'Syne',sans-serif`;
  const lines=wrapL(ctx2,scene.words.join(' '),1280-tx-72);
  const lh=bfs*1.28,totalH=lines.length*lh,ty0=(H-totalH)/2+bfs*.82;
  ctx2.shadowColor=theme.acc+'50';ctx2.shadowBlur=28;
  if(anim==='Word by Word'){let wi=0;const rev=Math.floor(prog*scene.words.length*1.3);lines.forEach((line,li)=>{let x=tx,y=ty0+li*lh;line.split(' ').forEach(w=>{const al=wi<rev?1:Math.max(0,1-(wi-rev)*1.8);ctx2.fillStyle=theme.txt+aHex3(al);ctx2.fillText(w,x,y);x+=ctx2.measureText(w+' ').width;wi++;});});}
  else if(anim==='Fade In'){ctx2.fillStyle=theme.txt+aHex3(Math.min(1,prog*2.5));lines.forEach((l,li)=>ctx2.fillText(l,tx,ty0+li*lh));}
  else if(anim==='Rise Up'){const off=Math.max(0,(1-Math.min(1,prog*2.5)))*55;ctx2.fillStyle=theme.txt+aHex3(Math.min(1,prog*2.5));lines.forEach((l,li)=>ctx2.fillText(l,tx,ty0+li*lh+off));}
  else if(anim==='Typewriter'){const tot=scene.text.length,sh=Math.floor(prog*tot*1.15);let cum=0;ctx2.fillStyle=theme.txt;lines.forEach((line,li)=>{const y=ty0+li*lh;if(cum>=sh)return;const toS=Math.min(line.length,sh-cum);ctx2.fillText(line.slice(0,toS),tx,y);if(toS<line.length){const cx2=tx+ctx2.measureText(line.slice(0,toS)).width;ctx2.fillStyle=theme.acc;ctx2.fillRect(cx2,y-bfs*.82,3,bfs);ctx2.fillStyle=theme.txt;}cum+=line.length+1;});}
  ctx2.shadowBlur=0;
  ctx2.font=`400 20px 'DM Mono',monospace`;ctx2.fillStyle=theme.acc+'bb';ctx2.fillText(`${String(si+1).padStart(2,'0')} / ${String(V.scenes.length).padStart(2,'0')}`,tx,60);
  ctx2.font=`400 16px 'DM Sans',sans-serif`;ctx2.fillStyle=theme.acc+'70';ctx2.textAlign='right';ctx2.fillText('StoryScript AI',1280-40,32);ctx2.textAlign='left';
  if(theme.bars||theme.vig){ctx2.fillStyle='rgba(0,0,0,.72)';ctx2.fillRect(0,0,1280,38);ctx2.fillRect(0,H-46,1280,38);}
  const gp=(scene.t0+prog*scene.dur)/Math.max(V.totalDur,1);ctx2.fillStyle='rgba(0,0,0,.45)';ctx2.fillRect(0,H-8,1280,8);ctx2.fillStyle=theme.acc;ctx2.fillRect(0,H-8,1280*gp,8);

  // Captions
  const globalT=scene.t0+prog*scene.dur;
  renderCaps(ctx2,globalT,1280,H,theme);

  if(prog<.07){ctx2.fillStyle=`rgba(0,0,0,${(1-prog/.07)*.9})`;ctx2.fillRect(0,0,1280,H);}
  if(prog>.9) {ctx2.fillStyle=`rgba(0,0,0,${((prog-.9)/.1)*.9})`;ctx2.fillRect(0,0,1280,H);}
}

// Captions
function genCaps(){
  captions=[];if(!V.scenes.length)return;
  const wpc=parseInt(document.querySelector('#cap-wpc .tag.on')?.textContent||'5');
  const allW=[];
  V.scenes.forEach(sc=>{const wps=sc.words.length/sc.dur;sc.words.forEach((word,wi)=>{const t0=sc.t0+wi/wps;allW.push({word,t0,t1:sc.t0+(wi+1)/wps});});});
  for(let i=0;i<allW.length;i+=wpc){const ch=allW.slice(i,i+wpc);if(ch.length)captions.push({text:ch.map(w=>w.word).join(' '),words:ch,t0:ch[0].t0,t1:ch[ch.length-1].t1});}
}
function pickCap(el,style){document.querySelectorAll('.cap-card').forEach(c=>c.classList.remove('on'));el.classList.add('on');capStyle=style;}

function renderCaps(ctx2,gT,W,H,theme){
  const enabled=document.getElementById('cap-tog')?.classList.contains('on');
  if(!enabled||!captions.length)return;
  const cap=captions.find(c=>gT>=c.t0&&gT<c.t1);if(!cap)return;
  const pos=document.querySelector('#cap-pos .tag.on')?.textContent||'Bottom';
  const fadeIn=Math.min(1,(gT-cap.t0)/.12),fadeOut=Math.min(1,(cap.t1-gT)/.1);
  const alpha=Math.min(fadeIn,fadeOut);if(alpha<=0)return;
  ctx2.save();ctx2.globalAlpha=alpha;
  const bfs=Math.round(42);
  const mY=pos==='Bottom'?H-80:pos==='Top'?110:H/2+bfs/2;
  if(capStyle==='bold-bar'){
    ctx2.font=`800 ${bfs}px 'Syne',sans-serif`;ctx2.textAlign='center';
    const tw=ctx2.measureText(cap.text).width,pad=22,bh=bfs*1.45,bx=W/2-tw/2-pad,by=mY-bfs*.82;
    ctx2.fillStyle='rgba(0,0,0,.78)';ctx2.beginPath();if(ctx2.roundRect)ctx2.roundRect(bx,by,tw+pad*2,bh,8);else ctx2.rect(bx,by,tw+pad*2,bh);ctx2.fill();
    ctx2.fillStyle='#ffffff';ctx2.fillText(cap.text,W/2,mY);
  }else if(capStyle==='word-pop'){
    const aw=cap.words.find(w=>gT>=w.t0&&gT<w.t1)||cap.words[0];
    const wp=Math.min(1,(gT-aw.t0)/.08),scale=1+(1-wp)*.25;
    ctx2.font=`800 ${Math.round(bfs*1.4*scale)}px 'Syne',sans-serif`;ctx2.textAlign='center';
    ctx2.shadowColor=theme.acc+'80';ctx2.shadowBlur=20;ctx2.fillStyle=theme.acc;ctx2.fillText(aw?.word?.toUpperCase()||'',W/2,mY);ctx2.shadowBlur=0;
  }else if(capStyle==='karaoke'){
    ctx2.font=`800 ${bfs}px 'Syne',sans-serif`;ctx2.textAlign='left';
    const tw2=ctx2.measureText(cap.text).width;let x=W/2-tw2/2;
    cap.words.forEach(wo=>{const isA=gT>=wo.t0&&gT<wo.t1,isP=gT>=wo.t1;ctx2.fillStyle=isA?theme.acc:isP?'rgba(255,255,255,.9)':'rgba(255,255,255,.3)';if(isA){ctx2.shadowColor=theme.acc+'80';ctx2.shadowBlur=18;}ctx2.fillText(wo.word,x,mY);ctx2.shadowBlur=0;x+=ctx2.measureText(wo.word+' ').width;});
  }else if(capStyle==='tiktok'){
    const fsize=Math.round(bfs*1.3);ctx2.font=`800 ${fsize}px 'Syne',sans-serif`;ctx2.textAlign='center';
    const tw3=ctx2.measureText(cap.text).width;let x2=W/2-tw3/2;
    cap.words.forEach(wo=>{const isA=gT>=wo.t0&&gT<wo.t1,ww=ctx2.measureText(wo.word).width,ws=ctx2.measureText(' ').width;const pad2=7;
    if(isA){ctx2.fillStyle=theme.acc;ctx2.beginPath();if(ctx2.roundRect)ctx2.roundRect(x2-pad2,mY-fsize*.88,ww+pad2*2,fsize*1.2,4);else ctx2.rect(x2-pad2,mY-fsize*.88,ww+pad2*2,fsize*1.2);ctx2.fill();ctx2.fillStyle='#000';}else ctx2.fillStyle='rgba(255,255,255,.85)';
    ctx2.fillText(wo.word,x2+ww/2,mY);x2+=ww+ws;});
  }
  ctx2.globalAlpha=1;ctx2.textAlign='left';ctx2.restore();
}

function wrapL(ctx2,text,maxW){const words=text.split(' '),lines=[];let cur='';for(const w of words){const t=cur?cur+' '+w:w;if(ctx2.measureText(t).width>maxW&&cur){lines.push(cur);cur=w;}else cur=t;}if(cur)lines.push(cur);return lines;}
function hrgb3(s){const m=s.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);return m?`${m[1]},${m[2]},${m[3]}`:'198,255,71';}
function aHex3(a){return Math.round(Math.max(0,Math.min(1,a))*255).toString(16).padStart(2,'0');}

function parseScenes(){
  const text=G.scriptText||document.getElementById('vo-script').value.trim();
  if(!text){V.scenes=[];updateSceneUI();return;}
  const sps=parseInt(document.getElementById('sps').value);
  const parts=text.split(/\n\n+/).filter(p=>p.trim());
  const arr=parts.length>1?parts:text.split(/\n/).filter(p=>p.trim().length>8);
  V.scenes=arr.map((p,i)=>{const clean=p.trim(),wds=clean.split(/\s+/),dur=Math.max(sps,Math.ceil(wds.length/2.2));return{i,text:clean,words:wds,dur,t0:0};});
  let t=0;V.scenes.forEach(s=>{s.t0=t;t+=s.dur;});V.totalDur=t;
  genCaps();updateSceneUI();updateVStat();
}

function updateSceneUI(){
  const list=document.getElementById('sc-list');list.innerHTML='';
  V.scenes.forEach((s,i)=>{
    const img=V.images[i];
    const card=document.createElement('div');card.className='sc-card'+(i===0?' on':'');card.id=`sc${i}`;
    const pt=V.prompts[i]?`<div class="sc-prompt-tip">"${V.prompts[i].slice(0,55)}‚Ä¶"</div>`:'';
    card.innerHTML=`<div class="sc-head" onclick="actSc(${i})"><span class="sc-n">S${String(i+1).padStart(2,'0')}¬∑${ft(s.t0)}</span><span class="sc-txt">${s.text.slice(0,44)}${s.text.length>44?'‚Ä¶':''}</span><span class="sc-d">${s.dur}s</span></div>
    <div class="sc-img-row">${img?`<img class="sc-thumb" src="${img.src}">`:`<div class="sc-noimg">No img</div>`}<div><div class="sc-btns"><button class="sc-btn" id="scb${i}" onclick="fetchBroll(${i})">ü§ñ AI</button><button class="sc-btn" onclick="upBroll(${i})">üìÅ</button>${img?`<button class="sc-btn" onclick="clrBroll(${i})">‚úï</button>`:''}</div>${pt}</div></div>`;
    list.appendChild(card);
  });
  updateVStat();
}
function actSc(i){document.querySelectorAll('.sc-card').forEach(c=>c.classList.remove('on'));document.getElementById(`sc${i}`)?.classList.add('on');rfrC(i,.4);}
function updateVStat(){document.getElementById('st-sc').textContent=V.scenes.length;document.getElementById('st-dur').textContent=ft(V.totalDur);document.getElementById('st-br').textContent=`${Object.keys(V.images).length}/${V.scenes.length}`;}

function rfrC(si=0,p=.4){
  if(!V.scenes.length){ctx3.clearRect(0,0,1280,720);ctx3.fillStyle='#07090f';ctx3.fillRect(0,0,1280,720);ctx3.fillStyle='rgba(255,255,255,.07)';ctx3.font="26px 'Syne',sans-serif";ctx3.textAlign='center';ctx3.fillText('Go to Stage 1 to generate a script',640,360);ctx3.textAlign='left';return;}
  initPtcl(getTheme());renderVFrame(ctx3,Math.min(si,V.scenes.length-1),p);
}

function previewVid(){if(!V.scenes.length)return;cancelAnimationFrame(V.prevAnimId);let si=0,sp=0,lt=null;initPtcl(getTheme());function loop(ts){if(!lt)lt=ts;const dt=Math.min((ts-lt)/1000,.05);lt=ts;const sc=V.scenes[si];if(!sc)return;sp+=dt/sc.dur;renderVFrame(ctx3,si,Math.min(sp,1));if(sp>=1){si++;sp=0;if(si>=V.scenes.length)return;}V.prevAnimId=requestAnimationFrame(loop);}V.prevAnimId=requestAnimationFrame(loop);}

// B-roll
async function fetchBroll(idx){
  const btn=document.getElementById(`scb${idx}`);if(btn){btn.classList.add('loading');btn.textContent='‚è≥';}
  const scene=V.scenes[idx];if(!scene)return;
  const prompt=build3Prompt(scene.text);V.prompts[idx]=prompt;
  try{const url=`https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=1280&height=720&seed=${idx*137+42}&nologo=true&enhance=true&model=flux`;V.images[idx]=await loadImg(url);toast(`Scene ${idx+1} image ready ‚ú®`,'ok');}
  catch(e){const fc=document.createElement('canvas');fc.width=1280;fc.height=720;const fctx=fc.getContext('2d');const ps=[['#0a1520','#000a18'],['#0d0820','#050010'],['#1a0800','#0a0000'],['#001a14','#00080a']];const[c1,c2]=ps[idx%ps.length];const g=fctx.createLinearGradient(0,0,1280,720);g.addColorStop(0,c1);g.addColorStop(1,c2);fctx.fillStyle=g;fctx.fillRect(0,0,1280,720);for(let i=0;i<5000;i++){fctx.fillStyle=`rgba(255,255,255,${Math.random()*.025})`;fctx.fillRect(Math.random()*1280,Math.random()*720,1,1);}const fi=new Image();fi.src=fc.toDataURL();V.images[idx]=fi;}
  if(btn){btn.classList.remove('loading');btn.textContent='üîÑ';}
  updateSceneUI();rfrC();
}
async function fetchAllBroll(){if(!V.scenes.length){toast('Parse scenes first','err');return;}toast(`Generating ${V.scenes.length} AI images...`,'info');for(let i=0;i<V.scenes.length;i++){await fetchBroll(i);await new Promise(r=>setTimeout(r,700));}toast('All images ready! üé®','ok');}
function upBroll(idx){const inp=document.createElement('input');inp.type='file';inp.accept='image/*';inp.onchange=async()=>{const f=inp.files[0];if(!f)return;try{V.images[idx]=await loadImg(URL.createObjectURL(f));updateSceneUI();rfrC();toast(`Scene ${idx+1} uploaded ‚úì`,'ok');}catch(e){toast('Load failed','err');}};inp.click();}
function clrBroll(idx){delete V.images[idx];delete V.prompts[idx];updateSceneUI();rfrC();}

// Render engine
async function toggleRender(){if(V.isRendering){stopRender();return;}if(!V.scenes.length){toast('No scenes','err');return;}startRender();}
async function startRender(){
  V.isRendering=true;V.chunks=[];V.webmBlob=null;
  cancelAnimationFrame(V.prevAnimId);cancelAnimationFrame(V.animId);
  initPtcl(getTheme());setRUI(true);
  document.getElementById('done-ov').classList.remove('show');
  let audioTrack=null;
  if(G.audioUrl){try{const ac=new(window.AudioContext||window.webkitAudioContext)();const ael=new Audio(G.audioUrl);ael.crossOrigin='anonymous';const src=ac.createMediaElementSource(ael);const dest=ac.createMediaStreamDestination();src.connect(dest);
    // Hook in music bed
    await setupMusicForRender(ac, dest.stream.getAudioTracks().length ? ac.destination : dest);
    audioTrack=dest.stream.getAudioTracks()[0];ael.play().catch(()=>{});}catch(e){}}
  const cs=vc3.captureStream(30);if(audioTrack)cs.addTrack(audioTrack);
  const mime=['video/webm;codecs=vp9,opus','video/webm;codecs=vp8,opus','video/webm'].find(m=>MediaRecorder.isTypeSupported(m))||'video/webm';
  V.mediaRecorder=new MediaRecorder(cs,{mimeType:mime,videoBitsPerSecond:5_000_000});
  V.mediaRecorder.ondataavailable=e=>{if(e.data.size>0)V.chunks.push(e.data);};
  V.mediaRecorder.onstop=finalizeWebM;V.mediaRecorder.start(80);
  let si=0,sp=0,lt=null,frame=0;
  const totalF=V.scenes.reduce((a,s)=>a+Math.ceil(s.dur*30),0);
  function loop(ts){if(!V.isRendering)return;if(!lt)lt=ts;const dt=Math.min((ts-lt)/1000,.05);lt=ts;const sc=V.scenes[si];if(!sc){stopRender();return;}sp+=dt/sc.dur;frame++;renderVFrame(ctx3,si,Math.min(sp,1));if(sp>=1){si++;sp=0;if(si>=V.scenes.length){stopRender();return;}}const pct=Math.min(100,(frame/Math.max(totalF,1))*100);setVProg(pct,`Scene ${si+1}/${V.scenes.length} ¬∑ ${pct.toFixed(0)}%`,frame);V.animId=requestAnimationFrame(loop);}
  V.animId=requestAnimationFrame(loop);toast('Rendering at 30fps...','info');
}
function stopRender(){V.isRendering=false;cancelAnimationFrame(V.animId);if(V.mediaRecorder&&V.mediaRecorder.state!=='inactive')V.mediaRecorder.stop();else resetRUI();}
function finalizeWebM(){V.webmBlob=new Blob(V.chunks,{type:'video/webm'});const sz=fmtB(V.webmBlob.size);document.getElementById('st-sz').textContent=sz;document.getElementById('done-sub').textContent=`${ft(V.totalDur)} ¬∑ ${sz}`;document.getElementById('done-ov').classList.add('show');document.getElementById('exp-webm').disabled=false;document.getElementById('exp-mp4').disabled=false;resetRUI();setVProg(100,'Render complete ‚úì');document.getElementById('st-dot').className='sd g';document.getElementById('st-st').textContent='Done';markDone(3);toast(`Video ready! ${sz} üé¨`,'ok');}

async function exportMP4(){
  if(!V.webmBlob){toast('Render first!','err');return;}if(typeof VideoEncoder==='undefined'){toast('WebCodecs needs Chrome 94+','err');return;}if(V.mp4Encoding)return;V.mp4Encoding=true;
  document.getElementById('mp4prog').classList.add('show');document.getElementById('exp-mp4').disabled=true;setMP4P(0,'Initializing...');
  try{const Muxer=window.Mp4Muxer?.Muxer||window['mp4-muxer']?.Muxer;if(!Muxer)throw new Error('mp4-muxer not loaded');
  const FPS=24,W=1280,H=720,muxer=new Muxer({target:new window.Mp4Muxer.ArrayBufferTarget(),video:{codec:'avc',width:W,height:H},fastStart:'in-memory'});
  const enc=new VideoEncoder({output:(chunk,meta)=>muxer.addVideoChunk(chunk,meta),error:e=>{throw e;}});
  enc.configure({codec:'avc1.42001f',width:W,height:H,bitrate:4_000_000,framerate:FPS});
  const totalF=Math.ceil(V.totalDur*FPS);initPtcl(getTheme());
  for(let f=0;f<totalF;f++){const t=f/FPS;let si=0;for(let i=0;i<V.scenes.length;i++){if(t>=V.scenes[i].t0&&(i===V.scenes.length-1||t<V.scenes[i+1].t0)){si=i;break;}}const sc=V.scenes[si],sp=sc?Math.min(1,(t-sc.t0)/sc.dur):1;renderVFrame(offCtx,si,sp);const ib=await createImageBitmap(offsc);const vf=new VideoFrame(ib,{timestamp:Math.round(f*(1_000_000/FPS))});enc.encode(vf,{keyFrame:f%(FPS*2)===0});vf.close();ib.close();if(f%8===0){setMP4P(5+(f/totalF)*87,`Encoding ${f+1}/${totalF}`);await new Promise(r=>setTimeout(r,0));}}
  setMP4P(93,'Flushing...');await enc.flush();enc.close();setMP4P(97,'Muxing...');muxer.finalize();
  const mp4=new Blob([muxer.target.buffer],{type:'video/mp4'});const url=URL.createObjectURL(mp4);const a=document.createElement('a');a.href=url;a.download=`storyscript-${Date.now()}.mp4`;a.click();URL.revokeObjectURL(url);
  setMP4P(100,`Done! ${fmtB(mp4.size)} ‚úì`);toast(`MP4 exported! ${fmtB(mp4.size)}`,'ok');setTimeout(()=>document.getElementById('mp4prog').classList.remove('show'),4000);}
  catch(e){console.error(e);toast('MP4 failed: '+e.message,'err');document.getElementById('mp4prog').classList.remove('show');}
  V.mp4Encoding=false;document.getElementById('exp-mp4').disabled=false;
}
function dlWebM(){if(!V.webmBlob){toast('Render first!','err');return;}const a=document.createElement('a');a.href=URL.createObjectURL(V.webmBlob);a.download=`storyscript-${Date.now()}.webm`;a.click();toast('WebM downloading üé¨','ok');}

function setRUI(on){document.getElementById('render-btn').className='bigbtn'+(on?' stop':'');document.getElementById('ri').textContent=on?'‚èπ':'üé¨';document.getElementById('rt').textContent=on?(' Stop Rendering'):(' Render Video');document.getElementById('rendprog').style.display=on?'block':'none';const rb=document.getElementById('rec-badge');rb.classList.toggle('live',on);rb.innerHTML=on?'<span class="recdot"></span>REC ¬∑ 1280√ó720 ¬∑ 30fps':'1280 √ó 720 ¬∑ 30fps';document.getElementById('st-dot').className='sd '+(on?'r':'g');document.getElementById('st-st').textContent=on?'Rendering‚Ä¶':'Ready';}
function resetRUI(){V.isRendering=false;setRUI(false);}
function setVProg(pct,lbl,f){document.getElementById('lpfill').style.width=pct+'%';document.getElementById('cpfill').style.width=pct+'%';document.getElementById('lplbl').textContent=lbl;document.getElementById('lppct').textContent=pct.toFixed(0)+'%';document.getElementById('vplbl').textContent=lbl;document.getElementById('vppct').textContent=pct.toFixed(0)+'%';}
function setMP4P(pct,lbl){document.getElementById('mp4fill').style.width=pct+'%';document.getElementById('mp4lbl').textContent=lbl;}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STAGE 4 ‚Äî THUMBNAIL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TLAY=[
  {n:'Left Heavy', svg:`<svg viewBox="0 0 160 90" fill="none"><rect width="160" height="90" fill="#0d1017"/><rect x="6" y="18" width="80" height="10" rx="2" fill="#c6ff47" opacity=".9"/><rect x="6" y="32" width="65" height="7" rx="2" fill="white" opacity=".5"/><rect x="100" y="10" width="54" height="70" rx="4" fill="white" opacity=".07"/></svg>`},
  {n:'Centered',  svg:`<svg viewBox="0 0 160 90" fill="none"><rect width="160" height="90" fill="#0d1017"/><rect x="20" y="22" width="120" height="12" rx="2" fill="#c6ff47" opacity=".9"/><rect x="35" y="39" width="90" height="7" rx="2" fill="white" opacity=".5"/><rect x="55" y="62" width="50" height="14" rx="3" fill="#c6ff47" opacity=".2"/></svg>`},
  {n:'Big Number',svg:`<svg viewBox="0 0 160 90" fill="none"><rect width="160" height="90" fill="#0d1017"/><rect x="6" y="22" width="60" height="8" rx="2" fill="white" opacity=".9"/><rect x="6" y="35" width="50" height="7" rx="2" fill="#c6ff47" opacity=".7"/><text x="95" y="72" font-size="70" font-weight="900" fill="#c6ff47" opacity=".5" font-family="Arial">7</text></svg>`},
  {n:'Top Banner',svg:`<svg viewBox="0 0 160 90" fill="none"><rect width="160" height="90" fill="#0d1017"/><rect y="0" width="160" height="28" fill="#c6ff47" opacity=".15"/><rect x="10" y="8" width="100" height="10" rx="2" fill="#c6ff47" opacity=".9"/><rect x="10" y="40" width="140" height="7" rx="2" fill="white" opacity=".3"/></svg>`},
  {n:'Split',     svg:`<svg viewBox="0 0 160 90" fill="none"><rect width="160" height="90" fill="#0d1017"/><rect width="80" height="90" fill="white" opacity=".04"/><rect x="6" y="22" width="68" height="10" rx="2" fill="#c6ff47" opacity=".9"/><line x1="80" y1="0" x2="80" y2="90" stroke="#c6ff47" stroke-width="2" opacity=".3"/></svg>`},
  {n:'Face Right',svg:`<svg viewBox="0 0 160 90" fill="none"><rect width="160" height="90" fill="#0d1017"/><rect x="6" y="20" width="82" height="11" rx="2" fill="white" opacity=".9"/><rect x="6" y="36" width="70" height="7" rx="2" fill="#c6ff47" opacity=".7"/><ellipse cx="124" cy="45" rx="26" ry="35" fill="white" opacity=".07"/></svg>`},
];
const TVAR=[{acc:'#c6ff47',l:'Lime'},{acc:'#ff6b35',l:'Fire'},{acc:'#47b4ff',l:'Ice'},{acc:'#ffd700',l:'Gold'},{acc:'#ff3d6b',l:'Red'},{acc:'#b47fff',l:'Volt'}];
const TSTOPS=new Set(['the','a','an','and','or','but','in','on','at','to','for','of','with','is','are','was','were','be','this','that','it','they','we','you','i','have','do','will','not','so','as','by','from','about','than','when','who','what','how','if','can','just','all','more','most','some','any','also','very','get','let','us','them']);
const TVISUALS={money:'gold coins wealth luxury cityscape',wealth:'luxury penthouse rooftop night city',millionaire:'businessman luxury success confident',success:'mountain peak achievement golden dawn',habit:'morning sunrise discipline focus',mindset:'mind power clarity energy glow',history:'ancient ruins dramatic epic',tech:'futuristic neon circuit cyberpunk',science:'laboratory light beam research',health:'athletic vitality nature energy',secret:'spotlight revelation dramatic contrast',power:'lightning storm energy force',world:'earth globe dramatic clouds'};
const TSTYLES={Cinematic:'cinematic photography, anamorphic flare, dramatic grade, 4K',Dramatic:'intense contrast, epic dramatic lighting, cinematic',Abstract:'abstract art, bold geometric, vibrant palette','Dark Luxury':'dark luxury, moody gold editorial','Nature Epic':'epic nature golden hour, photorealistic'};

function syncToThumb(){
  const topic=G.topic||document.getElementById('g-topic').value||'success';
  if(!document.getElementById('th-headline').value||document.getElementById('th-headline').value==='THEY NEVER TALK ABOUT THIS'){
    document.getElementById('th-sub').value=topic.charAt(0).toUpperCase()+topic.slice(1);
  }
  syncTLayers();
}

function buildTLayoutGrid(){
  const grid=document.getElementById('th-layouts');grid.innerHTML='';
  TLAY.forEach((l,i)=>{const card=document.createElement('div');card.className='lcard'+(i===T.activeLayout?' on':'');card.title=l.n;card.innerHTML=l.svg;card.onclick=()=>{T.activeLayout=i;document.querySelectorAll('.lcard').forEach(c=>c.classList.remove('on'));card.classList.add('on');applyTLayout(i);dbrT();};grid.appendChild(card);});
}

function applyTLayout(i){
  const hl=T.layers.find(l=>l.type==='headline'),sl=T.layers.find(l=>l.type==='sub'),bl=T.layers.find(l=>l.type==='badge');
  const D=[{hl:{x:.052,y:.45,align:'left'},sl:{x:.052,y:.60,align:'left'},bl:{x:.80,y:.60,align:'center'}},{hl:{x:.5,y:.38,align:'center'},sl:{x:.5,y:.55,align:'center'},bl:{x:.5,y:.75,align:'center'}},{hl:{x:.052,y:.38,align:'left'},sl:{x:.052,y:.52,align:'left'},bl:{x:.70,y:.72,align:'center'}},{hl:{x:.5,y:.15,align:'center'},sl:{x:.5,y:.55,align:'center'},bl:{x:.5,y:.75,align:'center'}},{hl:{x:.04,y:.40,align:'left'},sl:{x:.04,y:.55,align:'left'},bl:{x:.75,y:.60,align:'center'}},{hl:{x:.04,y:.38,align:'left'},sl:{x:.04,y:.55,align:'left'},bl:{x:.04,y:.72,align:'left'}}];
  const d=D[i];if(!d)return;if(hl)Object.assign(hl,d.hl);if(sl)Object.assign(sl,d.sl);if(bl)Object.assign(bl,d.bl);
}

function buildTLayersPanel(){
  const panel=document.getElementById('tlayers-panel');panel.innerHTML='';
  T.layers.forEach(layer=>{
    const card=document.createElement('div');card.className='layer-card'+(layer.id===T.activeId?' alc':'');card.onclick=()=>{T.activeId=layer.id;buildTLayersPanel();};
    card.innerHTML=`<div class="lc-head"><span class="lc-type">${layer.type}</span><input class="lc-inp" value="${esc(layer.text)}" oninput="updTL(${layer.id},'text',this.value)"><button class="lc-del" onclick="delTL(${layer.id},event)">‚úï</button></div>
    <div class="lc-row">
      <div><div style="font-size:.6rem;color:var(--m);margin-bottom:3px">Font</div><select class="mini" onchange="updTL(${layer.id},'font',this.value)">${['Bebas Neue','Anton','Oswald','Syne','DM Sans'].map(f=>`<option ${f===layer.font?'selected':''}>${f}</option>`).join('')}</select></div>
      <div><div style="font-size:.6rem;color:var(--m);margin-bottom:3px">Color</div><input type="color" value="${layer.color}" style="width:28px;height:28px;border-radius:4px;border:1px solid var(--b2);cursor:pointer;background:none" onchange="updTL(${layer.id},'color',this.value)"></div>
      <div><div style="font-size:.6rem;color:var(--m);margin-bottom:3px">Size</div><input class="mini" type="number" value="${layer.size}" min="12" max="400" onchange="updTL(${layer.id},'size',+this.value)"></div>
      <div><div style="font-size:.6rem;color:var(--m);margin-bottom:3px">Align</div><select class="mini" onchange="updTL(${layer.id},'align',this.value)"><option ${layer.align==='left'?'selected':''}>left</option><option ${layer.align==='center'?'selected':''}>center</option><option ${layer.align==='right'?'selected':''}>right</option></select></div>
    </div>
    <div style="display:flex;gap:10px;margin-top:7px">
      <label style="display:flex;align-items:center;gap:4px;font-size:.69rem;color:var(--m);cursor:pointer"><input type="checkbox" ${layer.shadow?'checked':''} onchange="updTL(${layer.id},'shadow',this.checked)"> Shadow</label>
      <label style="display:flex;align-items:center;gap:4px;font-size:.69rem;color:var(--m);cursor:pointer"><input type="checkbox" ${layer.outline?'checked':''} onchange="updTL(${layer.id},'outline',this.checked)"> Outline</label>
      <label style="display:flex;align-items:center;gap:4px;font-size:.69rem;color:var(--m);cursor:pointer"><input type="checkbox" ${layer.upper?'checked':''} onchange="updTL(${layer.id},'upper',this.checked)"> CAPS</label>
    </div>`;
    panel.appendChild(card);
  });
  const ab=document.createElement('button');ab.className='add-lbtn';ab.textContent='+ Add Layer';ab.onclick=addTLayer;panel.appendChild(ab);
}

function updTL(id,prop,val){const l=T.layers.find(x=>x.id===id);if(l){l[prop]=val;dbrT();buildTLayersPanel();}}
function delTL(id,e){e.stopPropagation();T.layers=T.layers.filter(l=>l.id!==id);if(T.activeId===id)T.activeId=T.layers[0]?.id;buildTLayersPanel();dbrT();}
function addTLayer(){T.layers.push({id:T.nextId++,type:'text',text:'New Text',font:'Syne',size:60,color:'#ffffff',shadow:true,outline:false,x:.05,y:.5,align:'left',upper:false});T.activeId=T.nextId-1;buildTLayersPanel();dbrT();}

function syncTLayers(){
  const hl=T.layers.find(l=>l.type==='headline'),sl=T.layers.find(l=>l.type==='sub'),bl=T.layers.find(l=>l.type==='badge');
  if(hl)hl.text=document.getElementById('th-headline').value;
  if(sl)sl.text=document.getElementById('th-sub').value;
  if(bl)bl.text=document.getElementById('th-badge').value;
}

function renderThumb(tCtx=tctx,w=1280,h=720){
  const sx=w/1280,sy=h/720;
  const bgMode=document.querySelector('#th-bg .tag.on')?.textContent||'Gradient';
  const dim=parseInt(document.getElementById('tod').value)/100;
  tCtx.clearRect(0,0,w,h);
  if(T.bgImage&&(bgMode==='AI Generated'||bgMode==='Upload Photo')){
    const iR=T.bgImage.naturalWidth/T.bgImage.naturalHeight,cR=w/h;let sw,sh,sxx,sy2;
    if(iR>cR){sh=h;sw=h*iR;sy2=0;sxx=(w-sw)/2;}else{sw=w;sh=w/iR;sxx=0;sy2=(h-sh)/2;}
    tCtx.drawImage(T.bgImage,sxx,sy2,sw,sh);tCtx.fillStyle=`rgba(0,0,0,${dim})`;tCtx.fillRect(0,0,w,h);
  }else{
    const cols=[['#04060e','#0e1628'],['#0e0500','#221200'],['#000810','#0a1830'],['#080010','#180028']];
    const pair=cols[Math.abs(hashS(document.getElementById('g-topic').value||'x'))%cols.length];
    const g=tCtx.createLinearGradient(0,0,w,h);g.addColorStop(0,pair[0]);g.addColorStop(1,pair[1]);tCtx.fillStyle=g;tCtx.fillRect(0,0,w,h);
  }
  drawTLayoutBG(tCtx,T.activeLayout,w,h,sx,sy);
  T.layers.forEach(l=>drawTLayer(tCtx,l,w,h,sx,sy));
  tCtx.strokeStyle=T.accent+'22';tCtx.lineWidth=6*sx;tCtx.strokeRect(0,0,w,h);
}

function drawTLayoutBG(ctx2,layout,w,h,sx,sy){
  if(layout===0){ctx2.fillStyle=T.accent;ctx2.fillRect(w*.033,0,5*sx,h);ctx2.fillStyle=T.accent+'22';ctx2.fillRect(w*.046,0,3*sx,h);}
  if(layout===1){ctx2.fillStyle='rgba(0,0,0,.55)';ctx2.fillRect(0,0,w,h*.16);ctx2.fillRect(0,h*.84,w,h*.16);ctx2.fillStyle=T.accent;ctx2.fillRect(0,h*.155,w,3*sy);ctx2.fillRect(0,h*.845,w,3*sy);}
  if(layout===2){const glow=ctx2.createRadialGradient(w*.85,h*.5,0,w*.85,h*.5,w*.45);glow.addColorStop(0,T.accent+'22');glow.addColorStop(1,'transparent');ctx2.fillStyle=glow;ctx2.fillRect(0,0,w,h);}
  if(layout===3){ctx2.fillStyle='rgba(0,0,0,.72)';ctx2.fillRect(0,0,w,h*.22);ctx2.fillStyle=T.accent;ctx2.fillRect(0,h*.22,w,4*sy);}
  if(layout===4){ctx2.fillStyle='rgba(0,0,0,.55)';ctx2.fillRect(0,0,w*.5,h);ctx2.fillStyle=T.accent;ctx2.fillRect(w*.499,0,4*sx,h);}
  if(layout===5){ctx2.fillStyle='rgba(0,0,0,.45)';ctx2.fillRect(0,0,w*.6,h);ctx2.fillStyle=T.accent;ctx2.fillRect(0,0,5*sx,h);}
}

function drawTLayer(ctx2,layer,w,h,sx,sy){
  const font=layer.font||'Bebas Neue',size=(layer.size||80)*sx,text=layer.upper?(layer.text||'').toUpperCase():(layer.text||'');
  const lx=layer.x*w,ly=layer.y*h,align=layer.align||'left',maxW=align==='center'?w*.88:(layer.x>.5?w*(1-layer.x-.03):w*.65);
  ctx2.font=`800 ${size}px '${font}',sans-serif`;ctx2.textAlign=align;
  if(layer.shadow){ctx2.shadowColor='rgba(0,0,0,.9)';ctx2.shadowBlur=20*sx;ctx2.shadowOffsetX=3*sx;ctx2.shadowOffsetY=3*sy;}
  const words2=(text||'').split(' '),lines2=[];let cur2='';
  for(const ww of words2){const t=cur2?cur2+' '+ww:ww;if(ctx2.measureText(t).width>maxW&&cur2){lines2.push(cur2);cur2=ww;}else cur2=t;}if(cur2)lines2.push(cur2);
  const lh2=size*1.15;
  lines2.forEach((line,li)=>{
    const dx=align==='center'?w/2:lx,dy=ly+li*lh2;
    if(layer.outline){ctx2.strokeStyle='#000';ctx2.lineWidth=size*.075;ctx2.lineJoin='round';ctx2.strokeText(line,dx,dy);}
    ctx2.fillStyle=layer.color;ctx2.fillText(line,dx,dy);
  });
  ctx2.shadowColor='transparent';ctx2.shadowBlur=0;ctx2.shadowOffsetX=0;ctx2.shadowOffsetY=0;ctx2.textAlign='left';
}

function buildVariants(){
  const strip=document.getElementById('var-strip');strip.innerHTML='';
  TVAR.forEach(vc=>{
    const wrap=document.createElement('div');wrap.className='vthumb'+(vc.acc===T.accent?' on':'');
    const vc2=document.createElement('canvas');vc2.width=192;vc2.height=108;
    const vctx=vc2.getContext('2d');const sv=T.accent;T.accent=vc.acc;renderThumb(vctx,192,108);T.accent=sv;
    const lbl=document.createElement('div');lbl.className='vt-lbl';lbl.textContent=vc.l;
    wrap.appendChild(vc2);wrap.appendChild(lbl);
    wrap.onclick=()=>{document.querySelectorAll('.vthumb').forEach(v=>v.classList.remove('on'));wrap.classList.add('on');T.accent=vc.acc;document.querySelectorAll('.swatch').forEach(s=>s.classList.toggle('on',s.dataset.c===vc.acc));renderThumb();};
    strip.appendChild(wrap);
  });
}

async function genAIBG(){
  if(T.isGenerating)return;T.isGenerating=true;
  const topic=G.topic||document.getElementById('g-topic').value||'success';
  const style=document.querySelector('#th-aibg .tag.on')?.textContent||'Cinematic';
  setBL('aibg-btn','aibg-spin','aibg-icon','aibg-txt','Generating...',true);
  document.getElementById('shimmer').classList.add('show');
  pt(document.querySelector('#th-bg .tag'),  'th-bg'); // pick AI Generated
  document.querySelectorAll('#th-bg .tag').forEach(t=>{t.classList.toggle('on',t.textContent==='AI Generated');});
  const raw=topic.toLowerCase().replace(/[^a-z\s]/g,' ').split(/\s+/).filter(w=>w.length>3&&!TSTOPS.has(w));
  const exp=raw.map(w=>TVISUALS[w]||'').find(v=>v)||raw.slice(0,3).join(' ')||'success wealth drama';
  const prompt=`${exp}, ${TSTYLES[style]||TSTYLES.Cinematic}, no text no words, landscape 16:9`;
  try{T.bgImage=await loadImg(`https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=1280&height=720&seed=${Math.floor(Math.random()*9999)+1}&nologo=true&enhance=true&model=flux`);document.getElementById('th-bg-status').textContent='AI Generated ‚úì';toast('AI background ready! ‚ú®','ok');}
  catch(e){T.bgImage=null;document.getElementById('th-bg-status').textContent='Gradient (fallback)';toast('Generation failed ‚Äî gradient fallback','info');}
  document.getElementById('shimmer').classList.remove('show');
  setBL('aibg-btn','aibg-spin','aibg-icon','aibg-txt','Regenerate AI Background',false);
  T.isGenerating=false;
  renderThumb();buildVariants();
}

function pickAcc(el){document.querySelectorAll('.swatch').forEach(s=>s.classList.remove('on'));el.classList.add('on');T.accent=el.dataset.c;renderThumb();buildVariants();}
function dbrT(){clearTimeout(T.renderTimer);T.renderTimer=setTimeout(()=>{syncTLayers();renderThumb();},55);}
function loadBGPhoto(f){if(!f)return;loadImg(URL.createObjectURL(f)).then(img=>{T.bgImage=img;document.querySelectorAll('#th-bg .tag').forEach(t=>t.classList.toggle('on',t.textContent==='Upload Photo'));renderThumb();buildVariants();toast('BG photo loaded ‚úì','ok');});}
function exportThumbnail(){syncTLayers();renderThumb();const a=document.createElement('a');a.download=`thumbnail-${Date.now()}.png`;a.href=tc.toDataURL('image/png');a.click();markDone(4);toast('PNG exported! 1280√ó720 ‚úì','ok');}
async function copyTCanvas(){try{syncTLayers();renderThumb();tc.toBlob(async blob=>{await navigator.clipboard.write([new ClipboardItem({'image/png':blob})]);toast('Copied to clipboard! üìã','ok');},'image/png');}catch(e){toast('Copy failed ‚Äî use Export','err');}}
const HLS=['THEY LIED TO YOU','THE TRUTH THEY HID','NOBODY TALKS ABOUT THIS','THIS CHANGES EVERYTHING','STOP DOING THIS NOW','THE #1 SECRET','WHAT THEY HIDE','YOU\'VE BEEN WRONG'];
const ACCS=['#c6ff47','#ff6b35','#47b4ff','#ffd700','#ff3d6b','#b47fff'];
function randomizeThumbnail(){const hl=T.layers.find(l=>l.type==='headline');if(hl){hl.text=HLS[Math.floor(Math.random()*HLS.length)];document.getElementById('th-headline').value=hl.text;}T.accent=ACCS[Math.floor(Math.random()*ACCS.length)];document.querySelectorAll('.swatch').forEach(s=>s.classList.toggle('on',s.dataset.c===T.accent));T.activeLayout=Math.floor(Math.random()*TLAY.length);buildTLayoutGrid();applyTLayout(T.activeLayout);renderThumb();buildVariants();buildTLayersPanel();toast('Randomized! üé≤','info');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SHARED UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadImg(url){return new Promise((res,rej)=>{const img=new Image();img.crossOrigin='anonymous';const t=setTimeout(()=>rej(new Error('timeout')),22000);img.onload=()=>{clearTimeout(t);if(img.naturalWidth>0)res(img);else rej(new Error('empty'));};img.onerror=()=>{clearTimeout(t);rej(new Error('load error'));};img.src=url;});}
function ft(s){if(!s||isNaN(s))return'0:00';return`${Math.floor(s/60)}:${String(Math.floor(s%60)).padStart(2,'0')}`;}
function fmtB(b){if(b<1024*1024)return(b/1024).toFixed(0)+' KB';return(b/1024/1024).toFixed(1)+' MB';}
function toast(msg,type='ok'){const c=document.getElementById('toasts');const t=document.createElement('div');t.className=`toast ${type}`;t.textContent=msg;c.appendChild(t);setTimeout(()=>{t.style.opacity='0';t.style.transition='opacity .3s';},3400);setTimeout(()=>t.remove(),3900);}
function setBL(btn,spin,icon,txt,label,on){document.getElementById(btn).disabled=on;document.getElementById(spin).style.display=on?'block':'none';document.getElementById(icon).style.display=on?'none':'inline';document.getElementById(txt).textContent=label;}
function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;');}
function hashS(s){let h=0;for(let i=0;i<s.length;i++){h=(Math.imul(31,h)+s.charCodeAt(i))|0;}return h;}

function scaleV(){const a=document.getElementById('c3area');const W=a.clientWidth-32,H=a.clientHeight-32;const r=Math.min(W/1280,H/720);vc3.style.width=Math.floor(1280*r)+'px';vc3.style.height=Math.floor(720*r)+'px';}
function scaleTc(){const a=document.getElementById('tc-area');const W=a.clientWidth-40,H=a.clientHeight-40;const r=Math.min(W/1280,H/720);tc.style.width=Math.floor(1280*r)+'px';tc.style.height=Math.floor(720*r)+'px';}

document.getElementById('th-bg').addEventListener('click',e=>{if(e.target.textContent==='Upload Photo'&&e.target.classList.contains('tag'))document.getElementById('bg-upload').click();});
window.addEventListener('resize',()=>{if(curStage===3)scaleV();if(curStage===4)scaleTc();});


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FEATURE: A/B HOOK VARIANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let abVariants = [];

async function generateABVariants() {
  const topic = G.topic || document.getElementById('g-topic').value.trim();
  if(!topic){ toast('Generate a script first','err'); return; }
  document.getElementById('ab-btn').disabled = true;
  document.getElementById('ab-spin').style.display = 'block';
  document.getElementById('ab-btn-txt').textContent = 'Generating‚Ä¶';
  document.getElementById('ab-panel').style.display = 'block';
  document.getElementById('ab-cards').innerHTML = '<div style="color:var(--m);font-size:.77rem;padding:8px 0">Generating hook variants with AI‚Ä¶</div>';

  const prompt = `Generate exactly 3 different hook variants for a YouTube video about: "${topic}"
Each hook should be 1-3 sentences, use a different angle: curiosity, shock/stat, or story.
Reply ONLY with valid JSON array, no markdown, no extra text:
[{"label":"Curiosity","text":"..."},{"label":"Shock Stat","text":"..."},{"label":"Story","text":"..."}]`;

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:600,messages:[{role:'user',content:prompt}]})});
    const d = await res.json();
    const raw = d.content?.[0]?.text||'[]';
    const clean = raw.replace(/```json|```/g,'').trim();
    abVariants = JSON.parse(clean);
  } catch(e) {
    abVariants = [
      {label:'Curiosity', text:`What if everything you know about ${topic} is completely backwards? In the next few minutes, I'll show you the counterintuitive truth that changes everything.`},
      {label:'Shock Stat', text:`95% of people trying to master ${topic} fail within 90 days ‚Äî not because they lack willpower, but because they're following advice designed to keep them stuck.`},
      {label:'Story', text:`Three years ago I was exactly where you are now, frustrated and getting nowhere with ${topic}. Then one conversation changed everything. Here's what I learned.`}
    ];
  }

  const colors = ['var(--a)','var(--a2)','var(--a3)'];
  document.getElementById('ab-cards').innerHTML = abVariants.map((v,i)=>`
    <div class="ab-card${i===0?' chosen':''}" onclick="pickABVariant(${i})">
      <div class="ab-badge" style="background:rgba(${i===0?'198,255,71':i===1?'255,107,53':'71,180,255'},.12);color:${colors[i]}">${v.label}</div>
      <div class="ab-text">${v.text}</div>
    </div>`).join('');

  document.getElementById('ab-btn').disabled = false;
  document.getElementById('ab-spin').style.display = 'none';
  document.getElementById('ab-btn-txt').textContent = 'Regenerate';
  toast('3 hook variants ready ‚Äî pick one! üé£','ok');
}

function pickABVariant(i) {
  document.querySelectorAll('.ab-card').forEach((c,ci)=>c.classList.toggle('chosen',ci===i));
  const variant = abVariants[i];
  if(!variant) return;
  // Replace hook section in scriptText
  const hookRe = /\[HOOK\]([\s\S]*?)(\[INTRO\]|$)/i;
  const raw = document.getElementById('s1out')?.innerHTML || '';
  G.scriptText = G.scriptText.replace(hookRe, `[HOOK]\n${variant.text}\n\n[INTRO]`);
  // Also update the visible output
  const hookDiv = document.querySelector('#s1out .s1-out-section');
  if(hookDiv) {
    const next = hookDiv.nextElementSibling;
    if(next){
      const label = next.querySelector('.s1-sec-label');
      if(label && label.textContent.includes('Hook')){
        next.querySelector('.s1-sec-text').innerHTML = variant.text.replace(/\n/g,'<br>');
      }
    }
  }
  document.getElementById('vo-script').value = G.scriptText;
  toast(`Hook variant "${variant.label}" selected ‚úì`,'ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FEATURE: MUSIC BED WITH AUTO-DUCK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MUS = { enabled: false, trackUrl: '', audio: null, gainNode: null, ctx: null };

function toggleMusicBed(tog) {
  tog.classList.toggle('on');
  MUS.enabled = tog.classList.contains('on');
  document.getElementById('music-panel').style.display = MUS.enabled ? 'block' : 'none';
  if(!MUS.enabled && MUS.audio){ MUS.audio.pause(); }
}

function selTrack(el, key) {
  document.querySelectorAll('.mtrack').forEach(t=>t.classList.remove('on'));
  el.classList.add('on');
  MUS.trackUrl = el.dataset.url || '';
  if(MUS.audio){ MUS.audio.pause(); MUS.audio = null; }
}

function updateMusicVol() {
  const vol = parseInt(document.getElementById('music-vol').value) / 100;
  if(MUS.gainNode) MUS.gainNode.gain.value = vol;
  if(MUS.audio) MUS.audio.volume = vol;
}

async function setupMusicForRender(audioCtx, destination) {
  if(!MUS.enabled || !MUS.trackUrl) return null;
  try {
    const vol = parseInt(document.getElementById('music-vol').value) / 100;
    const duck = document.getElementById('duck-tog').classList.contains('on');
    const musEl = new Audio(MUS.trackUrl);
    musEl.crossOrigin = 'anonymous';
    musEl.loop = true;
    musEl.volume = vol;
    const src = audioCtx.createMediaElementSource(musEl);
    const gain = audioCtx.createGain();
    gain.gain.value = vol;
    MUS.gainNode = gain;
    src.connect(gain);
    gain.connect(destination);
    musEl.play().catch(()=>{});
    // If ducking is on and voiceover exists, reduce music when VO is playing
    if(duck && G.audioUrl) {
      const voEl = document.querySelector('#bgaudio');
      if(voEl) {
        voEl.addEventListener('play', ()=>{ if(gain) gain.gain.setTargetAtTime(vol*0.2, audioCtx.currentTime, 0.3); });
        voEl.addEventListener('pause', ()=>{ if(gain) gain.gain.setTargetAtTime(vol, audioCtx.currentTime, 0.5); });
      }
    }
    return musEl;
  } catch(e) { console.warn('Music setup failed:', e); return null; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FEATURE: SRT SUBTITLE EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function generateSRT() {
  if(!captions.length){ toast('No captions ‚Äî render a video first','err'); return ''; }
  let srt = '';
  captions.forEach((cap, i) => {
    const t0 = cap.t0, t1 = cap.t1;
    const fmt = t => {
      const h=Math.floor(t/3600), m=Math.floor((t%3600)/60), s=Math.floor(t%60), ms=Math.round((t%1)*1000);
      return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')},${String(ms).padStart(3,'0')}`;
    };
    srt += `${i+1}\n${fmt(t0)} --> ${fmt(t1)}\n${cap.text}\n\n`;
  });
  return srt.trim();
}

function openSRTModal() {
  if(!captions.length){ toast('Generate a voiceover and captions first','err'); return; }
  const srt = generateSRT();
  document.getElementById('srt-preview').textContent = srt;
  document.getElementById('srt-modal').classList.add('open');
}

function downloadSRT() {
  const srt = generateSRT();
  const title = (G.topic||'subtitles').replace(/[^a-z0-9]/gi,'-').toLowerCase();
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([srt],{type:'text/plain'}));
  a.download = `${title}-subtitles.srt`;
  a.click();
  toast('SRT file downloading ‚úì','ok');
}

function copySRT() {
  navigator.clipboard.writeText(generateSRT()).then(()=>toast('SRT copied! üìã','ok'));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FEATURE: YOUTUBE CHAPTERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function generateChapters() {
  if(!V.scenes.length){ toast('No scenes ‚Äî generate a script first','err'); return ''; }
  // Group scenes into logical chapters (every ~3-5 scenes or by content)
  const lines = ['0:00 Intro'];
  let prevTime = 0;
  const groupSize = Math.max(2, Math.floor(V.scenes.length / 6));
  V.scenes.forEach((sc, i) => {
    if(i > 0 && i % groupSize === 0 && sc.t0 - prevTime > 20) {
      const t = sc.t0;
      const m = Math.floor(t/60), s = Math.floor(t%60);
      const label = sc.text.split(' ').slice(0,5).join(' ').replace(/[^a-zA-Z0-9 ]/g,'');
      lines.push(`${m}:${String(s).padStart(2,'0')} ${label}‚Ä¶`);
      prevTime = t;
    }
  });
  // Add CTA at end
  if(V.totalDur > 60) {
    const t = Math.max(0, V.totalDur - 30);
    const m = Math.floor(t/60), s = Math.floor(t%60);
    lines.push(`${m}:${String(s).padStart(2,'0')} Conclusion & CTA`);
  }
  return lines.join('\n');
}

function openChaptersModal() {
  if(!V.scenes.length){ toast('Generate a script and scenes first','err'); return; }
  document.getElementById('chapters-preview').textContent = generateChapters();
  document.getElementById('chapters-modal').classList.add('open');
}

function copyChapters() {
  navigator.clipboard.writeText(generateChapters()).then(()=>toast('Chapters copied! üìã','ok'));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FEATURE: ANALYTICS PREVIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openAnalyticsModal() {
  const title = document.getElementById('yt-title')?.value || G.topic || '';
  const script = G.scriptText || '';
  const dur = V.totalDur || 0;
  const hasThumb = !!(T.bgImage);
  const hasBroll = Object.keys(V.images).length;
  const sceneCount = V.scenes.length;

  // Score components
  const titleScore = scoreTitle(title);
  const hookScore = scoreHook(script);
  const retentionScore = Math.min(100, Math.round(50 + (dur > 300 ? 20 : dur/300*20) + (hasBroll/Math.max(sceneCount,1))*20 + (hasThumb?10:0)));
  const ctrScore = Math.min(100, Math.round(titleScore * 0.5 + (hasThumb?30:10) + 10));
  const seoScore = Math.min(100, Math.round(scoreSEO(script)));
  const overallScore = Math.round((titleScore + hookScore + retentionScore + ctrScore + seoScore) / 5);

  const metrics = [
    {label:'Overall Score', val:overallScore+'%', color:'var(--a)', pct:overallScore},
    {label:'CTR Potential', val:ctrScore+'%', color:'var(--a2)', pct:ctrScore},
    {label:'Hook Strength', val:hookScore+'%', color:'var(--a3)', pct:hookScore},
    {label:'Retention Est.', val:retentionScore+'%', color:'var(--a4)', pct:retentionScore},
  ];

  document.getElementById('analytics-grid').innerHTML = metrics.map(m=>`
    <div class="ametric">
      <div class="am-val" style="color:${m.color}">${m.val}</div>
      <div class="am-lbl">${m.label}</div>
      <div class="am-bar"><div class="am-fill" style="width:${m.pct}%;background:${m.color}"></div></div>
    </div>`).join('');

  // Tips
  const tips = [];
  if(titleScore < 60) tips.push('üìå Add a number or power word to your title (e.g. "7 Secrets", "Never", "Finally")');
  if(!hasThumb) tips.push('üñºÔ∏è Design a thumbnail in Stage 4 ‚Äî it can double your CTR');
  if(hookScore < 65) tips.push('üé£ Strengthen your hook with a shocking stat or bold promise in the first 15 seconds');
  if(hasBroll < sceneCount * 0.5) tips.push('üé¨ Add more B-roll images ‚Äî videos with visuals every scene retain 40% more viewers');
  if(dur < 300) tips.push('‚è±Ô∏è Videos over 5 minutes earn more ad revenue and rank better in search');
  if(seoScore < 60) tips.push('üîç Add more keywords to your [SEO TAGS] section for better discoverability');
  if(!tips.length) tips.push('‚úÖ Looking strong! Upload and monitor real-time analytics in YouTube Studio.');

  document.getElementById('analytics-tips').innerHTML = tips.map(t=>`<div style="padding:3px 0;display:flex;gap:6px"><span>${t.slice(0,2)}</span><span>${t.slice(2)}</span></div>`).join('');
  document.getElementById('analytics-modal').classList.add('open');
}

function scoreTitle(t) {
  if(!t) return 30;
  let s = 40;
  if(/\d/.test(t)) s += 15;
  if(/never|secret|truth|nobody|finally|stop|warning|exposed/i.test(t)) s += 15;
  if(t.length >= 30 && t.length <= 70) s += 15;
  if(/\?|!/.test(t)) s += 8;
  if(t.length > 100) s -= 10;
  return Math.min(100, s);
}
function scoreHook(script) {
  if(!script) return 25;
  const hook = script.slice(0, 300).toLowerCase();
  let s = 40;
  if(/\?/.test(hook)) s += 15;
  if(/\d+%|\d+ (people|million|billion)/i.test(hook)) s += 20;
  if(/(what if|imagine|secret|truth|wrong|lie|never told)/i.test(hook)) s += 15;
  if(hook.length > 80) s += 10;
  return Math.min(100, s);
}
function scoreSEO(script) {
  const tagsM = document.getElementById('s1out')?.innerText?.match(/\[SEO TAGS\]\s*([\s\S]+?)(?:\[|$)/i);
  if(!tagsM) return 35;
  const tags = tagsM[1].split(/,|\n/).map(t=>t.trim()).filter(Boolean);
  return Math.min(100, 30 + tags.length * 7);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FEATURE: SCHEDULE UPLOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleSchedule() {
  const val = document.getElementById('yt-privacy').value;
  document.getElementById('yt-schedule-row').style.display = val === 'scheduled' ? 'block' : 'none';
  if(val === 'scheduled') {
    // Default to tomorrow at 9am
    const d = new Date(); d.setDate(d.getDate()+1); d.setHours(9,0,0,0);
    document.getElementById('yt-schedule-dt').value = d.toISOString().slice(0,16);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// YOUTUBE UPLOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const YT = { token: null, clientId: null, expiresAt: 0 };

function openYTModal(){
  const modal = document.getElementById("yt-modal");
  modal.style.display = "flex";
  const titleM = document.getElementById("s1out")?.innerText?.match(/\[TITLE\]\s*(.+)/i);
  if(titleM) document.getElementById("yt-title").value = titleM[1].trim().slice(0,100);
  else if(G.topic) document.getElementById("yt-title").value = G.topic.slice(0,100);
  const descParts = [G.scriptText?.slice(0,400)||"", "\n\n---\nCreated with StoryScript AI"].filter(Boolean);
  document.getElementById("yt-desc").value = descParts.join("");
  const tagsM = document.getElementById("s1out")?.innerText?.match(/\[SEO TAGS\]\s*([\s\S]+?)(?:\[|$)/i);
  if(tagsM) document.getElementById("yt-tags").value = tagsM[1].trim().replace(/\n/g,", ").slice(0,500);
  const vsEl = document.getElementById("yt-video-status");
  if(V.webmBlob){ vsEl.style.color="var(--ok)"; vsEl.textContent="‚úì Video ready ‚Äî "+fmtB(V.webmBlob.size)+" WebM"; }
  else { vsEl.style.color="var(--warn)"; vsEl.textContent="‚ö† No video rendered yet ‚Äî go to Stage 3 and render first"; }
  const saved = localStorage.getItem("yt_client_id");
  if(saved) document.getElementById("yt-client-id").value = saved;
  if(YT.token && Date.now() < YT.expiresAt){ showYTForm(); }
}

function closeYTModal(){ document.getElementById("yt-modal").style.display="none"; }

function showYTForm(){
  document.getElementById("yt-step-setup").style.display="none";
  document.getElementById("yt-step-form").style.display="block";
}

function ytDisconnect(){
  YT.token=null; YT.expiresAt=0;
  document.getElementById("yt-step-setup").style.display="block";
  document.getElementById("yt-step-form").style.display="none";
  document.getElementById("yt-result").style.display="none";
  document.getElementById("yt-prog-wrap").style.display="none";
}

function ytConnect(){
  const clientId = document.getElementById("yt-client-id").value.trim();
  if(!clientId){ toast("Paste your OAuth Client ID first","err"); return; }
  YT.clientId = clientId;
  localStorage.setItem("yt_client_id", clientId);
  const scope = encodeURIComponent("https://www.googleapis.com/auth/youtube.upload https://www.googleapis.com/auth/userinfo.profile");
  const redirectUri = encodeURIComponent(window.location.href.split("?")[0].split("#")[0]);
  const state = Math.random().toString(36).slice(2);
  sessionStorage.setItem("yt_oauth_state", state);
  const authUrl = "https://accounts.google.com/o/oauth2/v2/auth?client_id="+clientId+"&redirect_uri="+redirectUri+"&response_type=token&scope="+scope+"&state="+state+"&include_granted_scopes=true";
  const popup = window.open(authUrl, "yt_oauth", "width=520,height=620,left=200,top=100");
  if(!popup){ toast("Popup blocked ‚Äî allow popups for this page","err"); return; }
  document.getElementById("yt-conn-txt").textContent = "‚è≥ Waiting for Google‚Ä¶";
  const checkPopup = setInterval(()=>{
    try{
      if(popup.closed){ clearInterval(checkPopup); document.getElementById("yt-conn-txt").textContent="üîó Connect Google Account"; return; }
      const hash = popup.location.hash;
      if(hash && hash.includes("access_token")){
        clearInterval(checkPopup); popup.close();
        const params = new URLSearchParams(hash.slice(1));
        const token = params.get("access_token");
        const expiresIn = parseInt(params.get("expires_in")||"3600");
        YT.token = token; YT.expiresAt = Date.now() + expiresIn * 1000;
        fetch("https://www.googleapis.com/oauth2/v2/userinfo",{headers:{Authorization:"Bearer "+token}})
          .then(r=>r.json()).then(u=>{ document.getElementById("yt-connected-as").textContent="Connected as "+(u.name||u.email||"Google User"); })
          .catch(()=>{ document.getElementById("yt-connected-as").textContent="Connected to Google"; });
        showYTForm(); toast("Google account connected! ‚úì","ok");
      }
    } catch(e){ }
  }, 500);
}

async function doYTUpload(){
  if(!YT.token || Date.now() >= YT.expiresAt){ toast("Session expired ‚Äî reconnect Google account","err"); ytDisconnect(); return; }
  if(!V.webmBlob){ toast("No video ‚Äî render in Stage 3 first","err"); return; }
  const title = document.getElementById("yt-title").value.trim()||"My Video";
  const desc  = document.getElementById("yt-desc").value.trim();
  const tags  = document.getElementById("yt-tags").value.split(",").map(t=>t.trim()).filter(Boolean);
  const priv  = document.getElementById("yt-privacy").value;
  const isScheduled = priv === 'scheduled';
  const schedDt = isScheduled ? document.getElementById("yt-schedule-dt")?.value : null;
  document.getElementById("yt-upload-go").disabled=true;
  document.getElementById("yt-spin").style.display="block";
  document.getElementById("yt-upload-txt").textContent="Uploading‚Ä¶";
  document.getElementById("yt-prog-wrap").style.display="block";
  document.getElementById("yt-result").style.display="none";
  try{
    const statusObj = isScheduled && schedDt
      ? { privacyStatus:"private", publishAt: new Date(schedDt).toISOString() }
      : { privacyStatus: priv === 'scheduled' ? 'private' : priv };
    const meta = { snippet:{ title, description:desc, tags, categoryId:"22" }, status: statusObj };
    const initRes = await fetch("https://www.googleapis.com/upload/youtube/v3/videos?uploadType=resumable&part=snippet,status",{
      method:"POST",
      headers:{ Authorization:"Bearer "+YT.token, "Content-Type":"application/json", "X-Upload-Content-Type": V.webmBlob.type||"video/webm", "X-Upload-Content-Length": String(V.webmBlob.size) },
      body: JSON.stringify(meta)
    });
    if(!initRes.ok){ const e=await initRes.text(); throw new Error("Init failed: "+initRes.status+" "+e); }
    const uploadUrl = initRes.headers.get("Location");
    if(!uploadUrl) throw new Error("No upload URL from YouTube");
    await new Promise((resolve, reject)=>{
      const xhr = new XMLHttpRequest();
      xhr.open("PUT", uploadUrl);
      xhr.setRequestHeader("Content-Type", V.webmBlob.type||"video/webm");
      xhr.upload.onprogress = e=>{
        if(e.lengthComputable){
          const pct = Math.round(e.loaded/e.total*100);
          document.getElementById("yt-prog-fill").style.width=pct+"%";
          document.getElementById("yt-prog-pct").textContent=pct+"%";
          document.getElementById("yt-prog-lbl").textContent=pct<100?"Uploading‚Ä¶ "+fmtB(e.loaded)+" / "+fmtB(e.total):"Processing‚Ä¶";
        }
      };
      xhr.onload = ()=>{ if(xhr.status>=200&&xhr.status<300){ resolve(JSON.parse(xhr.responseText)); } else reject(new Error("Upload failed: "+xhr.status)); };
      xhr.onerror = ()=>reject(new Error("Network error during upload"));
      xhr.send(V.webmBlob);
    }).then(async videoData=>{
      const videoId = videoData.id;
      try{
        syncTLayers(); renderThumb();
        const thumbBlob = await new Promise(res=>tc.toBlob(res,"image/png"));
        if(thumbBlob){
          await fetch("https://www.googleapis.com/upload/youtube/v3/thumbnails/set?videoId="+videoId+"&uploadType=media",{
            method:"POST", headers:{ Authorization:"Bearer "+YT.token, "Content-Type":"image/png" }, body: thumbBlob
          });
        }
      }catch(e){ console.warn("Thumbnail upload skipped:",e); }
      document.getElementById("yt-result").style.display="block";
      document.getElementById("yt-result-link").href="https://www.youtube.com/watch?v="+videoId;
      document.getElementById("yt-result-link").textContent="youtube.com/watch?v="+videoId+" ‚Üí";
      document.getElementById("yt-prog-lbl").textContent="Upload complete!";
      document.getElementById("yt-prog-fill").style.width="100%";
      const schedNote = isScheduled && schedDt ? ` ¬∑ Scheduled for ${new Date(schedDt).toLocaleString()}` : '';
      toast("Uploaded to YouTube! üéâ"+schedNote,"ok");
    });
  }catch(e){ toast("Upload failed: "+e.message,"err"); console.error(e); }
  document.getElementById("yt-upload-go").disabled=false;
  document.getElementById("yt-spin").style.display="none";
  document.getElementById("yt-upload-txt").textContent="‚¨Ü Upload Video";
}

(function checkOAuthRedirect(){
  const hash = window.location.hash;
  if(hash.includes("access_token")){
    const params = new URLSearchParams(hash.slice(1));
    const token = params.get("access_token");
    if(token){ const expiresIn = parseInt(params.get("expires_in")||"3600"); YT.token = token; YT.expiresAt = Date.now() + expiresIn * 1000; history.replaceState(null,"",window.location.pathname+window.location.search); }
  }
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
goStage(1);
buildTLayoutGrid();
document.getElementById('s1').classList.add('active');
document.getElementById('ps1').classList.add('active');
initELKey();
toast('StoryScript AI ready ‚Äî start with Stage 1 ‚úçÔ∏è','info');
</script>
</body>
</html>
